<!DOCTYPE html>
<html lang="zh-CN">
<style>
    /* ... (style section is unchanged, with one addition) ... */
    /* Style for slide animation */
    #carousel-slide-container.sliding { transition: transform 0.5s ease-in-out; }
</style>
<body class="text-gray-800 dark:text-gray-200">
    <div id="app" class="flex flex-col min-h-screen"></div>
    <script>
        const App = {
            config: {
                // ...
            },
            state: {
                // ...,
                carouselData: null, // --- 新增 ---
                // ...
            },
            
            // ... (helpers, init, theme functions are unchanged) ...

            initCarousel() {
                const data = this.state.carouselData;
                if (!data || !data.slides || data.slides.length === 0) return;
                
                if (this.state.carouselInterval) clearInterval(this.state.carouselInterval);

                const container = document.getElementById('carousel-container');
                const slideContainer = document.getElementById('carousel-slide-container');
                const dots = container.querySelectorAll('.carousel-dot');
                const totalSlides = data.slides.length;
                let currentSlide = 0;

                const showSlide = (index) => {
                    if (data.mode === 'fade') {
                        const slides = slideContainer.querySelectorAll('.carousel-slide');
                        slides.forEach((slide, i) => {
                            slide.classList.toggle('opacity-100', i === index);
                            slide.classList.toggle('opacity-0', i !== index);
                        });
                    } else { // slide mode
                        slideContainer.classList.add('sliding');
                        slideContainer.style.transform = `translateX(-${index * 100}%)`;
                    }
                    
                    dots.forEach((dot, i) => {
                        dot.classList.toggle('bg-white', i === index);
                        dot.classList.toggle('bg-white/50', i !== index);
                    });
                    currentSlide = index;
                };

                const nextSlide = () => showSlide((currentSlide + 1) % totalSlides);

                dots.forEach(dot => {
                    dot.addEventListener('click', () => showSlide(parseInt(dot.dataset.slideTo)));
                });
                
                // For slide mode, handle transition end to avoid animation glitches on loop
                if (data.mode === 'slide') {
                    slideContainer.addEventListener('transitionend', () => {
                         slideContainer.classList.remove('sliding');
                    });
                }

                this.state.carouselInterval = setInterval(nextSlide, 5000);
            },
            
            async router() {
                const appContainer = document.getElementById('app');
                const path = window.location.hash.slice(1) || '/';
                
                await Promise.all([
                    this.fetchNavIfNeeded(),
                    this.fetchTagsIfNeeded(),
                    this.fetchFriendlyLinksIfNeeded(),
                    this.fetchRecentCommentsIfNeeded(),
                    this.fetchSiteStatsIfNeeded(),
                    this.fetchCarouselDataIfNeeded() // --- 新增 ---
                ]);
                
                await this.fetchDataIfNeeded();

                if (path === '/') {
                    appContainer.innerHTML = this.templates.mainLayout(this.templates.homePage(this.state.posts));
                    this.initCarousel(); // initCarousel will now use the fetched data
                } 
                // ... (rest of router is unchanged) ...
            },

            // --- Data Fetching ---
            async fetchCarouselDataIfNeeded() {
                if (!this.state.carouselData) {
                    try {
                        const res = await fetch(`${this.config.workerUrl}/api/carousel`);
                        this.state.carouselData = await res.json();
                    } catch (e) { console.error('Failed to fetch carousel data', e); }
                }
            },
            // ... (rest of fetch functions are unchanged) ...

            templates: {
                // ... (header and other templates are unchanged) ...
                carousel: () => {
                    const data = App.state.carouselData;
                    if (!data || !data.slides || data.slides.length === 0) return '';
                    
                    const isSlideMode = data.mode === 'slide';

                    const slidesHtml = data.slides.map((slide, index) => {
                        const slideContent = `<img src="${slide.imageUrl}" class="w-full h-full object-cover" alt="Carousel Image ${index + 1}">`;
                        const linkWrapper = (content) => slide.linkUrl && slide.linkUrl !== '#' ? `<a href="${slide.linkUrl}" target="_blank" class="block w-full h-full">${content}</a>` : content;
                        
                        if (isSlideMode) {
                            return `<div class="carousel-slide w-full h-full flex-shrink-0">${linkWrapper(slideContent)}</div>`;
                        } else { // Fade mode
                            return `<div class="carousel-slide absolute w-full h-full transition-opacity duration-700 ease-in-out ${index === 0 ? 'opacity-100' : 'opacity-0'}">${linkWrapper(slideContent)}</div>`;
                        }
                    }).join('');

                    return `
                    <div id="carousel-container" class="relative w-full h-[230px] overflow-hidden rounded-lg shadow-lg group">
                        <div id="carousel-slide-container" class="${isSlideMode ? 'flex w-full h-full' : ''}">
                            ${slidesHtml}
                        </div>
                        <div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex space-x-2">
                            ${data.slides.map((_, index) => `
                                <button class="carousel-dot h-3 w-3 rounded-full transition-colors ${index === 0 ? 'bg-white' : 'bg-white/50'}" data-slide-to="${index}"></button>
                            `).join('')}
                        </div>
                    </div>
                    `;
                },
                homePage: (posts, title = "最新文章") => {
                    return `
                        ${App.templates.carousel()}
                        <div class="mt-[18px]">
                            <h1 class="text-[1.3rem] font-bold mb-2">${title}</h1>
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                                <div class="divide-y divide-gray-200 dark:divide-gray-700">
                                    ${posts.length > 0 ? posts.map(post => App.templates.postCard(post)).join('') : '<p class="p-6">没有找到相关文章。</p>'}
                                </div>
                            </div>
                        </div>
                    `;
                },
                // ... (rest of the templates are unchanged) ...
            }
        };
        App.init();
    </script>
</body>
</html>
