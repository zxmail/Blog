<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的博客 - 管理后台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://gravatar.azure.cc/static/lib/fontawesome5pro/css/all.min.css?v=1.5.8">
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .ql-editor { min-height: 250px; font-size: 16px; line-height: 1.7; }
        .rounded-lg { border-radius: 0.3rem !important; }
        .rounded-md { border-radius: 0.1rem !important; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-200">

    <div id="app"></div>

    <script>
        const App = {
            config: {
                workerUrl: 'https://blog.xy193.workers.dev' // 请替换为您自己的Worker URL
            },
            state: {
                posts: [], navItems: [], friendlyLinks: [], recentComments: [], siteStats: null, categories: {},
                authToken: localStorage.getItem('authToken'), editorInstance: null, carouselSettings: null
            },

            init() {
                // ... (init function remains the same)
            },
            
            router: async () => {
                const appContainer = document.getElementById('app');
                if (!App.state.authToken) {
                    appContainer.innerHTML = App.templates.loginPage();
                    return;
                }
                appContainer.innerHTML = `<div class="flex justify-center items-center py-20"><div class="border-4 border-gray-200 border-t-4 border-t-blue-500 rounded-full w-12 h-12 animate-spin"></div></div>`;
                await Promise.all([ App.fetchDataIfNeeded(), App.fetchNavIfNeeded(), App.fetchFriendlyLinksIfNeeded(), App.fetchRecentCommentsIfNeeded(true), App.fetchSiteStatsIfNeeded(true), App.fetchCarouselSettingsIfNeeded() ]);
                appContainer.innerHTML = App.templates.adminDashboard();
            },
            
            fetchDataIfNeeded: async (force = true) => { /* ... */ },
            fetchNavIfNeeded: async () => { /* ... */ },
            fetchFriendlyLinksIfNeeded: async () => { /* ... */ },
            fetchRecentCommentsIfNeeded: async (force = true) => { /* ... */ },
            fetchSiteStatsIfNeeded: async (force = true) => { /* ... */ },
            fetchCarouselSettingsIfNeeded: async () => { if (!App.state.carouselSettings) try { const r = await fetch(`${App.config.workerUrl}/api/carousel-settings`); App.state.carouselSettings = await r.json(); } catch (e) {} },

            handleLogin: async (event) => { /* ... */ },
            handleLogout: () => { /* ... */ },
            showView: (viewName, param = null) => {
                const el = document.getElementById('admin-content');
                if(!el) return;
                if (viewName === 'posts') el.innerHTML = App.templates.postManager();
                else if (viewName === 'editor') { const post = param ? App.state.posts.find(p => p.slug === param) : {}; el.innerHTML = App.templates.postEditor(post); App.initEditor(post); } 
                else if (viewName === 'nav') el.innerHTML = App.templates.navEditor();
                else if (viewName === 'links') el.innerHTML = App.templates.friendlyLinksEditor();
                else if (viewName === 'settings') el.innerHTML = App.templates.siteSettingsEditor();
                else if (viewName === 'comments') el.innerHTML = App.templates.commentsManager();
                else if (viewName === 'carousel') el.innerHTML = App.templates.carouselSettingsEditor();
            },
            initEditor: (post = {}) => { /* ... */ },
            handlePostFormSubmit: async (e) => { /* ... */ },
            deletePost: async (slug) => { /* ... */ },
            addNavItemRow: () => { /* ... */ },
            removeNavItemRow: (btn) => btn.closest('.nav-item-row').remove(),
            handleNavFormSubmit: async (e) => { /* ... */ },
            addLinkItemRow: () => { /* ... */ },
            removeLinkItemRow: (btn) => btn.closest('.link-item-row').remove(),
            handleLinksFormSubmit: async (e) => { /* ... */ },
            deleteComment: async (id) => { /* ... */ },
            handleStatsFormSubmit: async (e) => { /* ... */ },
            
            addCarouselSlideRow: () => {
                const container = document.getElementById('carousel-slide-list');
                const div = document.createElement('div');
                div.className = 'carousel-slide-row grid grid-cols-12 gap-2';
                div.innerHTML = `
                    <input type="url" name="imageUrl" placeholder="图片 URL" class="col-span-6 px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
                    <input type="url" name="linkUrl" placeholder="超链接 URL" class="col-span-5 px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
                    <button type="button" onclick="App.removeCarouselSlideRow(this)" class="bg-red-500 text-white px-3 py-2 rounded-md col-span-1">-</button>
                `;
                container.appendChild(div);
            },
            removeCarouselSlideRow: (button) => {
                button.closest('.carousel-slide-row').remove();
            },
            handleCarouselSettingsSubmit: async (e) => {
                e.preventDefault();
                const form = e.target;
                const slideRows = form.querySelectorAll('.carousel-slide-row');
                const slides = Array.from(slideRows).map(row => ({
                    imageUrl: row.querySelector('[name="imageUrl"]').value,
                    linkUrl: row.querySelector('[name="linkUrl"]').value
                })).filter(s => s.imageUrl);

                const settings = {
                    transition: form.transition.value,
                    speed: parseInt(form.speed.value, 10),
                    delay: parseInt(form.delay.value, 10),
                    slides: slides
                };
                try {
                    const res = await fetch(`${App.config.workerUrl}/api/admin/carousel-settings`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${App.state.authToken}` },
                        body: JSON.stringify(settings)
                    });
                    if (res.ok) {
                        alert('轮播设置保存成功!');
                        App.state.carouselSettings = settings;
                    } else throw new Error('保存失败');
                } catch (err) {
                    alert('保存失败');
                }
            },
            
            templates: {
                loginPage: () => `...`,
                adminDashboard: () => `<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"><header class="flex justify-between items-center pb-4 border-b border-gray-200 dark:border-gray-700 mb-8"><h1 class="text-2xl font-bold">管理后台</h1><div><a href="index.html" class="text-blue-500 hover:underline mr-4">返回博客</a><button onclick="App.handleLogout()" class="bg-red-500 text-white py-2 px-4 rounded">退出</button></div></header><div class="flex gap-8"><aside class="w-1/5"><ul class="space-y-2"><li><button onclick="App.showView('posts')" class="w-full text-left font-semibold p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">文章管理</button></li><li><button onclick="App.showView('nav')" class="w-full text-left font-semibold p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">导航设置</button></li><li><button onclick="App.showView('links')" class="w-full text-left font-semibold p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">友链管理</button></li><li><button onclick="App.showView('comments')" class="w-full text-left font-semibold p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">评论管理</button></li><li><button onclick="App.showView('carousel')" class="w-full text-left font-semibold p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">海报轮播</button></li><li><button onclick="App.showView('settings')" class="w-full text-left font-semibold p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">网站设置</button></li></ul></aside><main id="admin-content" class="w-4/5">${App.templates.postManager()}</main></div></div>`,
                postManager: () => `...`,
                postEditor: (post = {}) => { /* ... */ },
                navEditor: () => `...`,
                friendlyLinksEditor: () => `...`,
                commentsManager: () => `...`,
                siteSettingsEditor: () => { /* ... */ },
                carouselSettingsEditor: () => {
                    const settings = App.state.carouselSettings || { transition: 'fade', speed: 700, delay: 5000, slides: [] };
                    return `<div class="w-full">
                        <h2 class="text-xl font-semibold mb-6">海报轮播设置</h2>
                        <form onsubmit="App.handleCarouselSettingsSubmit(event)" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow space-y-6">
                            <div>
                                <label for="transition" class="block text-sm font-medium">过渡动效</label>
                                <select id="transition" name="transition" class="mt-1 block w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
                                    <option value="fade" ${settings.transition === 'fade' ? 'selected' : ''}>渐变 (Fade)</option>
                                    <option value="slide-x" ${settings.transition === 'slide-x' ? 'selected' : ''}>水平滑动 (Slide X)</option>
                                    <option value="slide-y" ${settings.transition === 'slide-y' ? 'selected' : ''}>垂直滑动 (Slide Y)</option>
                                </select>
                            </div>
                            <div>
                                <label for="speed" class="block text-sm font-medium">动效速度 (毫秒)</label>
                                <input type="number" id="speed" name="speed" value="${settings.speed}" class="mt-1 block w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
                            </div>
                            <div>
                                <label for="delay" class="block text-sm font-medium">自动播放间隔 (毫秒)</label>
                                <input type="number" id="delay" name="delay" value="${settings.delay}" class="mt-1 block w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
                            </div>

                            <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
                                <h3 class="text-lg font-medium mb-4">幻灯片管理</h3>
                                <div class="grid grid-cols-12 gap-2 mb-2 text-sm font-semibold">
                                    <div class="col-span-6">图片 URL</div>
                                    <div class="col-span-5">超链接 URL</div>
                                </div>
                                <div id="carousel-slide-list" class="space-y-2 mb-4">
                                    ${(settings.slides || []).map(slide => `
                                        <div class="carousel-slide-row grid grid-cols-12 gap-2">
                                            <input type="url" name="imageUrl" placeholder="图片 URL" value="${slide.imageUrl}" class="col-span-6 px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
                                            <input type="url" name="linkUrl" placeholder="超链接 URL" value="${slide.linkUrl}" class="col-span-5 px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
                                            <button type="button" onclick="App.removeCarouselSlideRow(this)" class="bg-red-500 text-white px-3 py-2 rounded-md col-span-1">-</button>
                                        </div>
                                    `).join('')}
                                </div>
                                <button type="button" onclick="App.addCarouselSlideRow()" class="text-sm bg-gray-200 dark:bg-gray-700 py-2 px-4 rounded-md">+ 添加幻灯片</button>
                            </div>

                            <div class="text-right border-t border-gray-200 dark:border-gray-700 pt-6 mt-6">
                                <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md">保存设置</button>
                            </div>
                        </form>
                    </div>`;
                }
            }
        };
        App.init();
    </script>
</body>
</html>
