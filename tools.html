<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>在线工具 - 我的博客</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://gravatar.azure.cc/static/lib/fontawesome5pro/css/all.min.css?v=1.5.8">
    <script src="https://cdn.jsdelivr.net/npm/otpauth@9.2.2/dist/otpauth.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    
    <link rel="stylesheet" href="style.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'accent': '#28a745', 
                    },
                },
            },
        };
    </script>
    <style>
        body { background-color: #f7fafc; }
        .dark body { background-color: #1a202c; }
    </style>
</head>
<body class="text-gray-800 dark:text-gray-200">

    <div id="app" class="flex flex-col min-h-screen"></div>
    <div id="sidebar-container"></div>
    <div id="search-modal-container"></div>
    <div id="modal-container"></div>

    <button id="back-to-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="shadow-lg flex items-center justify-center hidden">
      <i class="far fa-arrow-up"></i>
    </button>
    
    <script src="main.js"></script>

    <script>
        Object.assign(App.state, {
            activeTool: '2fa',
            totp: null,
            totpInterval: null,
        });

        App.init = function() {
            this.applyTheme();
            this.renderMobileSidebar();
            this.renderSearchModal();
            document.getElementById('modal-container').innerHTML = this.templates.qrCodeModal();
            this.router();
            window.addEventListener('scroll', () => this.handleScroll());
        };

        App.router = async function() {
            const appContainer = document.getElementById('app');
            await Promise.all([ this.fetchNavIfNeeded(), this.fetchFriendlyLinksIfNeeded(), this.fetchSiteStatsIfNeeded(), this.fetchSiteSettingsIfNeeded() ]);
            appContainer.innerHTML = this.templates.mainLayout(this.templates.toolsPage());
            document.title = `在线工具 - ${this.state.siteSettings?.blogName || '我的博客'}`;
            this.renderMobileSidebar();
            this.renderToolContent();
        };

        App.setActiveTool = function(toolName) {
            if(this.state.totpInterval) clearInterval(this.state.totpInterval);
            this.state.activeTool = toolName;
            this.renderToolContent();
            document.querySelectorAll('.tool-sidebar a').forEach(a => a.classList.remove('active', 'bg-accent', 'text-white'));
            const activeLink = document.querySelector(`.tool-sidebar a[data-tool="${toolName}"]`);
            if (activeLink) {
                 activeLink.classList.add('active', 'bg-accent', 'text-white');
            }
        };

        App.renderToolContent = function() {
            const contentContainer = document.getElementById('tool-content-wrapper');
            if (!contentContainer) return;
            if (this.state.activeTool === '2fa') {
                contentContainer.innerHTML = this.templates.tool2FA();
            } else if (this.state.activeTool === 'qrcode') {
                contentContainer.innerHTML = this.templates.toolQRCode();
            }
        };

        App.update2FACode = function() {
            const resultArea = document.getElementById('2fa-result-container');
            if (resultArea) resultArea.classList.remove('hidden');

            const keyInput = document.getElementById('2fa-key-input');
            const secretKey = keyInput?.value.trim().replace(/\s/g, '');
            const codeDisplay = document.getElementById('2fa-code');
            const timeDisplay = document.getElementById('2fa-time');
            const progressDisplay = document.getElementById('2fa-progress');
            const keyDisplay = document.getElementById('2fa-key-display');
            const statusDisplay = document.getElementById('2fa-status');

            if (!keyInput || !codeDisplay || !timeDisplay || !progressDisplay || !keyDisplay) return; 
            if (this.state.totpInterval) clearInterval(this.state.totpInterval);
            
            keyDisplay.textContent = secretKey || '...';

            if (!secretKey) {
                codeDisplay.textContent = '------';
                timeDisplay.textContent = '剩余时间: N/A';
                statusDisplay.textContent = '请输入密钥';
                statusDisplay.classList.add('text-red-500');
                progressDisplay.style.width = '100%';
                return;
            }

            try {
                this.state.totp = new otpauth.TOTP({ secret: secretKey, period: 30 });
                const update = () => {
                    const token = this.state.totp.generate();
                    const remainingTime = 30 - (Math.floor(Date.now() / 1000) % 30);
                    const progress = (remainingTime / 30) * 100;
                    
                    codeDisplay.textContent = token;
                    timeDisplay.textContent = `剩余时间: ${remainingTime} 秒`;
                    progressDisplay.style.width = `${progress}%`;
                    
                    if (remainingTime <= 1) {
                        statusDisplay.textContent = '已超时, 需要重新点击获取!';
                        statusDisplay.classList.add('text-red-500');
                    } else {
                        statusDisplay.textContent = '已实时刷新';
                        statusDisplay.classList.remove('text-red-500');
                    }
                };
                update();
                this.state.totpInterval = setInterval(update, 1000);
            } catch (error) {
                codeDisplay.textContent = '密钥无效';
                timeDisplay.textContent = '请输入有效的Base32密钥';
                progressDisplay.style.width = '0%';
            }
        };

        App.generateAndShow2FAQRCode = function() {
            const secretKey = document.getElementById('2fa-key-input')?.value.trim();
            if (!secretKey) {
                alert('请输入密钥以生成二维码。');
                return;
            }
            const issuer = "在线工具";
            const user = "MyToken";
            const uri = `otpauth://totp/${encodeURIComponent(issuer)}:${encodeURIComponent(user)}?secret=${secretKey}&issuer=${encodeURIComponent(issuer)}`;
            
            const canvas = document.getElementById('qr-modal-canvas');
            if(canvas) {
                QRCode.toCanvas(canvas, uri, { width: 256, margin: 2 }, (error) => {
                    if (error) { alert('二维码生成失败!'); console.error(error); } 
                    else { this.openQrCodeModal(); }
                });
            }
        };
        
        App.openQrCodeModal = function() { document.getElementById('qr-modal')?.classList.remove('hidden'); }
        App.closeQrCodeModal = function() { document.getElementById('qr-modal')?.classList.add('hidden'); }

        App.generateQRCode = function() { /* Unchanged */ };

        Object.assign(App.templates, {
            mainLayout: (content) => `<div class="flex-grow">${App.templates.header()}<main class="max-w-7xl mx-auto w-full px-4 sm:px-6 py-8">${content}</main>${App.templates.friendlyLinksSection()}</div>${App.templates.footer()}`,
            toolsPage: () => `<div class="flex flex-col md:flex-row gap-6">${App.templates.toolSidebar()}<div id="tool-content-wrapper" class="flex-1 bg-white dark:bg-gray-800 rounded-lg shadow p-6 sm:p-8"></div></div>`,
            
            toolSidebar: () => `
                <aside class="w-full md:w-52 flex-shrink-0">
                    <nav class="tool-sidebar flex flex-row md:flex-col md:space-y-2 p-2 bg-white dark:bg-gray-800 rounded-lg shadow overflow-x-auto">
                        <a href="#" onclick="App.setActiveTool('2fa')" data-tool="2fa" class="flex flex-col items-center justify-center text-center p-4 rounded-lg active bg-accent text-white w-24 md:w-full flex-shrink-0 group">
                            <div class="w-12 h-12 flex items-center justify-center rounded-full bg-green-100 dark:bg-gray-700 mb-2 group-[.active]:bg-white/20"><i class="fas fa-user-shield text-2xl text-accent group-[.active]:text-white"></i></div>
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300 group-[.active]:text-white">2FA工具</span>
                        </a>
                        <a href="#" onclick="App.setActiveTool('qrcode')" data-tool="qrcode" class="flex flex-col items-center justify-center text-center p-4 rounded-lg w-24 md:w-full flex-shrink-0 group">
                             <div class="w-12 h-12 flex items-center justify-center rounded-full bg-gray-100 dark:bg-gray-700 mb-2 group-[.active]:bg-white/20"><i class="fas fa-qrcode text-2xl text-gray-500 group-[.active]:text-white"></i></div>
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300 group-[.active]:text-white">在线生成二维码</span>
                        </a>
                         <a href="#" class="flex flex-col items-center justify-center text-center p-4 rounded-lg w-24 md:w-full flex-shrink-0 group opacity-50 cursor-not-allowed">
                             <div class="w-12 h-12 flex items-center justify-center rounded-full bg-gray-100 dark:bg-gray-700 mb-2"><i class="fas fa-file-alt text-2xl text-gray-400"></i></div>
                            <span class="text-sm font-medium text-gray-500 dark:text-gray-400">文本处理</span>
                        </a>
                         <a href="#" class="flex flex-col items-center justify-center text-center p-4 rounded-lg w-24 md:w-full flex-shrink-0 group opacity-50 cursor-not-allowed">
                             <div class="w-12 h-12 flex items-center justify-center rounded-full bg-gray-100 dark:bg-gray-700 mb-2"><i class="fas fa-image text-2xl text-gray-400"></i></div>
                            <span class="text-sm font-medium text-gray-500 dark:text-gray-400">图片处理</span>
                        </a>
                         <a href="#" class="flex flex-col items-center justify-center text-center p-4 rounded-lg w-24 md:w-full flex-shrink-0 group opacity-50 cursor-not-allowed">
                             <div class="w-12 h-12 flex items-center justify-center rounded-full bg-gray-100 dark:bg-gray-700 mb-2"><i class="fas fa-ellipsis-h text-2xl text-gray-400"></i></div>
                            <span class="text-sm font-medium text-gray-500 dark:text-gray-400">更多工具</span>
                        </a>
                    </nav>
                </aside>
            `,

            tool2FA: () => `
                <div>
                    <h1 class="text-2xl font-bold mb-1">2FA验证</h1>
                    <p class="text-gray-500 dark:text-gray-400 mb-6">双重验证/二步验证码获取工具 (相当于谷歌身份验证器的网页版)，使用时选择您的方式输入密钥即可。</p>
                    
                    <div class="mb-4">
                        <input id="2fa-key-input" type="text" placeholder="点击此处输入密钥" class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-md focus:outline-none focus:border-accent dark:bg-gray-700">
                    </div>
                    <button onclick="App.update2FACode()" class="bg-accent text-white font-bold px-5 py-2.5 rounded-md hover:opacity-90 text-sm">点击获取验证码</button>
                    
                    <div id="2fa-result-container" class="mt-6 space-y-4 hidden">
                        <p><strong>双重密钥为:</strong> <span id="2fa-key-display" class="font-mono bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">...</span></p>
                        <p><strong>当前验证码:</strong> <span id="2fa-code" class="text-2xl font-mono font-bold tracking-widest text-accent">------</span> <span id="2fa-status" class="ml-2 font-bold"></span></p>
                        
                        <div class="flex items-center justify-between">
                             <p id="2fa-time" class="text-sm text-gray-500">剩余时间: N/A</p>
                             <button onclick="App.generateAndShow2FAQRCode()" class="bg-gray-600 text-white font-bold px-4 py-2 rounded-md hover:bg-gray-700 text-xs">生成二维码</button>
                        </div>

                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
                            <div id="2fa-progress" class="bg-accent h-1.5 rounded-full" style="width: 100%; transition: width 1s linear;"></div>
                        </div>
                    </div>

                    <hr class="my-8 dark:border-gray-700">
                    <div>
                        <h2 class="text-xl font-bold mb-2">2FA工具说明</h2>
                        <div class="text-sm text-gray-600 dark:text-gray-400 space-y-2">
                             <p><strong>演示密钥:</strong> 7J64V3P3E77J3IKNUGSZ5QANTLRLTKVL (点击密钥可复制)</p>
                            <p><strong>帮手提示:</strong> 必须在倒计时结束前输入 验证码登录或验证，否则会失效回显错误。...</p>
                            <p><strong>更多方式:</strong> 还可以将密钥跑在网址 (https://2fa.run/2fa/) 后面，示例: <a href="https://2fa.run/2fa/7J64V3P3E77J3IKNUGSZ5QANTLRLTKVL" class="text-blue-500 hover:underline" target="_blank">https://2fa.run/2fa/7J64V3P3E77J3IKNUGSZ5QANTLRLTKVL</a>。这样访问也可省去粘贴密钥，这样的方式发给新手使用，最合适不过。</p>
                             <p><strong>最近维护:</strong> 2023年10月22日</p>
                        </div>
                    </div>
                </div>
            `,
            toolQRCode: () => `...`, 
            
            qrCodeModal: () => `
                <div id="qr-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4" onclick="App.closeQrCodeModal()">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 relative text-center" onclick="event.stopPropagation()">
                         <h3 class="text-lg font-semibold mb-4">扫描二维码绑定</h3>
                         <canvas id="qr-modal-canvas"></canvas>
                         <p class="text-xs text-gray-500 mt-2">请使用 Authenticator App 扫描</p>
                         <button onclick="App.closeQrCodeModal()" class="mt-4 w-full bg-gray-200 dark:bg-gray-600 py-2 rounded">关闭</button>
                    </div>
                </div>
            `
        });

        App.init();
    </script>
</body>
</html>
