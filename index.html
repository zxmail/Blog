<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的博客</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://gravatar.azure.cc/static/lib/fontawesome5pro/css/all.min.css?v=1.5.8">
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
    <script>
        // Tailwind CSS Dark Mode Config
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .ql-editor { min-height: 250px; font-size: 16px; line-height: 1.7; }
        .content-area { font-size: 16px; line-height: 1.7; }
        .content-area a { color: #3b82f6; text-decoration: underline; }
        .dark .content-area a { color: #60a5fa; }
        .content-area h1, .content-area h2, .content-area h3 { font-weight: 600; margin-top: 1.5em; margin-bottom: 0.5em; border: none; padding: 0;}
        .content-area h1 { font-size: 2em; } .content-area h2 { font-size: 1.5em; } .content-area h3 { font-size: 1.25em; }
        .content-area p { margin-bottom: 1em; } .content-area ul, .content-area ol { padding-left: 2em; margin-bottom: 1em; }
        .content-area blockquote { border-left: 4px solid #e5e7eb; padding-left: 1em; margin-left: 0; color: #6b7280; }
        .dark .content-area blockquote { border-color: #4b5563; color: #9ca3af; }
        .content-area pre { background-color: #f3f4f6; padding: 1em; border-radius: 0.5rem; overflow-x: auto; color: #1f2937; }
        .dark .content-area pre { background-color: #1f2937; color: #d1d5db; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        .dark .loader { border-color: #4b5563; border-top-color: #60a5fa;}
        #back-to-top { position: fixed; bottom: 2rem; right: 2rem; display: none; }
        
        .group .dropdown-menu { display: none; }
        .group:hover .dropdown-menu { display: block; }
        .group .sub-menu { display: none; }
        .group-hover\:block .sub-menu { display: block; }
        .dark .dropdown-menu, .dark .sub-menu { background-color: #1f2937; border-color: #4b5563; }

        .rounded-lg { border-radius: 0.3rem !important; }
        .rounded-md { border-radius: 0.1rem !important; }
        .py-8 { padding-top: 1.5rem !important; padding-bottom: 1.8rem !important; }
        
        .border-gray-200 {
           --tw-border-opacity: 1;
            border-color: rgb(245 245 245 / var(--tw-border-opacity, 1)) !important;
        }
        .dark .dark\:divide-gray-700 > :not([hidden]) ~ :not([hidden]),
        .dark .dark\:border-gray-700 {
             --tw-border-opacity: 1;
            border-color: rgb(31 41 55 / var(--tw-border-opacity, 1)) !important;
        }

        body {
            background-color: #f5f5f5;
            transition-property: color, background-color, border-color, text-decoration-color, fill, stroke;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 300ms;
        }
        .dark body {
            background-color: #111827;
        }
    </style>
</head>
<body class="text-gray-800 dark:text-gray-200">

    <div id="app" class="flex flex-col min-h-screen"></div>
    
    <button id="back-to-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="bg-blue-500 hover:bg-blue-600 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center">
      <i class="fal fa-arrow-up"></i>
    </button>

    <script>
        const App = {
            config: {
                workerUrl: 'https://blog.xy193.workers.dev' // 请替换为您的 Worker URL
            },
            state: {
                posts: [],
                navItems: [],
                tags: [],
                categories: {},
                recentPosts: [],
                friendlyLinks: [],
                recentComments: [],
                siteStats: null,
                comments: {}, 
                theme: localStorage.getItem('theme') || 'light',
                carouselInterval: null
            },

            init() {
                this.applyTheme();
                window.addEventListener('hashchange', this.router);
                window.addEventListener('load', this.router);
                window.addEventListener('scroll', this.handleScroll);
            },
            
            applyTheme() {
                if (this.state.theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            },

            toggleTheme() {
                this.state.theme = this.state.theme === 'light' ? 'dark' : 'light';
                localStorage.setItem('theme', this.state.theme);
                this.applyTheme();
                const themeToggleButton = document.getElementById('theme-toggle-button');
                if(themeToggleButton) {
                    const themeIcon = this.state.theme === 'light'
                        ? `<i class="fal fa-moon h-5 w-5"></i>`
                        : `<i class="fal fa-sun h-5 w-5"></i>`;
                    themeToggleButton.innerHTML = themeIcon;
                }
            },
            
            initCarousel() {
                const container = document.getElementById('carousel-container');
                if (!container) return;
                
                if (this.state.carouselInterval) clearInterval(this.state.carouselInterval);

                let currentSlide = 0;
                const slides = container.querySelectorAll('.carousel-slide');
                const dots = container.querySelectorAll('.carousel-dot');
                const totalSlides = slides.length;

                if (totalSlides === 0) return;

                const showSlide = (index) => {
                    slides.forEach((slide, i) => {
                        slide.classList.toggle('opacity-100', i === index);
                        slide.classList.toggle('opacity-0', i !== index);
                    });
                    dots.forEach((dot, i) => {
                        dot.classList.toggle('bg-white', i === index);
                        dot.classList.toggle('bg-white/50', i !== index);
                    });
                    currentSlide = index;
                };

                const nextSlide = () => { showSlide((currentSlide + 1) % totalSlides); };
                const prevSlide = () => { showSlide((currentSlide - 1 + totalSlides) % totalSlides); };

                document.getElementById('carousel-next')?.addEventListener('click', nextSlide);
                document.getElementById('carousel-prev')?.addEventListener('click', prevSlide);
                dots.forEach(dot => {
                    dot.addEventListener('click', () => showSlide(parseInt(dot.dataset.slideTo)));
                });

                this.state.carouselInterval = setInterval(nextSlide, 5000);
            },

            handleScroll() {
                const backToTopButton = document.getElementById('back-to-top');
                if (window.scrollY > 300) { backToTopButton.style.display = 'flex'; } 
                else { backToTopButton.style.display = 'none'; }
            },
            helpers: {
                stripHtmlAndTruncate(html, length) {
                    const doc = new DOMParser().parseFromString(html, 'text/html');
                    const text = doc.body.textContent || "";
                    return text.length > length ? text.substring(0, length) + '...' : text;
                }
            },

            router: async () => {
                const appContainer = document.getElementById('app');
                appContainer.innerHTML = App.templates.loader();

                const path = window.location.hash.slice(1) || '/';
                const parts = path.split('/');
                
                await Promise.all([
                    App.fetchNavIfNeeded(),
                    App.fetchTagsIfNeeded(),
                    App.fetchFriendlyLinksIfNeeded(),
                    App.fetchRecentCommentsIfNeeded(),
                    App.fetchSiteStatsIfNeeded()
                ]);

                if (path === '/' || parts[1] === 'category' || parts[1] === 'tag' || path.startsWith('/search')) {
                   await App.fetchDataIfNeeded(true);
                } else {
                   await App.fetchDataIfNeeded();
                }

                if (path === '/') {
                    appContainer.innerHTML = App.templates.mainLayout(App.templates.homePage(App.state.posts));
                    App.initCarousel();
                } else if (parts[1] === 'post' && parts[2]) {
                    const slug = parts[2];
                    const post = await App.fetchSinglePost(slug);
                    await App.fetchCommentsForPost(slug);
                    if (post) {
                        const postIndex = App.state.posts.findIndex(p => p.slug === slug);
                        if (postIndex > -1) App.state.posts[postIndex] = post;
                        else App.state.posts.unshift(post);
                    }
                    appContainer.innerHTML = App.templates.mainLayout(App.templates.postPage(post));
                } else if (parts[1] === 'search' && parts[2]) {
                    const query = decodeURIComponent(parts[2]);
                    const results = await App.fetchSearchResults(query);
                    appContainer.innerHTML = App.templates.mainLayout(App.templates.homePage(results, `搜索结果: "${query}"`));
                    App.initCarousel();
                } else if (parts[1] === 'category' && parts.length > 2) {
                    const categoryName = parts.slice(2).map(decodeURIComponent).join('/');
                    const filteredPosts = App.state.posts.filter(p => p.category && p.category.startsWith(categoryName));
                    appContainer.innerHTML = App.templates.mainLayout(App.templates.homePage(filteredPosts, `分类: ${categoryName}`));
                    App.initCarousel();
                } else if (parts[1] === 'tag' && parts[2]) {
                    const tagName = decodeURIComponent(parts[2]);
                    const filteredPosts = App.state.posts.filter(p => p.tags && p.tags.includes(tagName));
                    appContainer.innerHTML = App.templates.mainLayout(App.templates.homePage(filteredPosts, `标签: ${tagName}`));
                    App.initCarousel();
                } else {
                    appContainer.innerHTML = App.templates.mainLayout(App.templates.notFoundPage());
                }
            },
            
            fetchNavIfNeeded: async () => { if (App.state.navItems.length === 0) { try { const res = await fetch(`${App.config.workerUrl}/api/nav`); App.state.navItems = await res.json(); } catch (e) { App.state.navItems = [{ label: '首页', url: '#/' }]; } } },
            fetchDataIfNeeded: async (forceRefresh = false) => { if (App.state.posts.length === 0 || forceRefresh) { try { const res = await fetch(`${App.config.workerUrl}/api/posts`); const posts = await res.json(); App.state.posts = posts; const categories = {}; posts.forEach(p => { const catParts = p.category.split('/'); catParts.forEach((part, i) => { const catPath = catParts.slice(0, i + 1).join('/'); categories[catPath] = (categories[catPath] || 0) + 1; }); }); App.state.categories = categories; App.state.recentPosts = posts.slice(0, 5); } catch (e) { console.error("Fetch posts error:", e); } } },
            fetchTagsIfNeeded: async () => { if (App.state.tags.length === 0) { try { const res = await fetch(`${App.config.workerUrl}/api/tags`); App.state.tags = await res.json(); } catch (e) { console.error(e); } } },
            fetchFriendlyLinksIfNeeded: async () => { if (App.state.friendlyLinks.length === 0) { try { const res = await fetch(`${App.config.workerUrl}/api/links`); App.state.friendlyLinks = await res.json(); } catch (e) { console.error("Fetch links error:", e); } } },
            fetchRecentCommentsIfNeeded: async (forceRefresh = false) => { if (App.state.recentComments.length === 0 || forceRefresh) { try { const res = await fetch(`${App.config.workerUrl}/api/comments/recent`); App.state.recentComments = await res.json(); } catch (e) { console.error("Fetch recent comments error:", e); } } },
            fetchCommentsForPost: async (slug) => { try { const res = await fetch(`${App.config.workerUrl}/api/comments/${slug}`); App.state.comments[slug] = await res.json(); } catch (e) { console.error(`Fetch comments for ${slug} error:`, e); App.state.comments[slug] = []; } },
            fetchSinglePost: async (slug) => { try { const response = await fetch(`${App.config.workerUrl}/api/posts/${slug}`); if (!response.ok) throw new Error('Post not found'); return await response.json(); } catch (error) { console.error("Fetch single post error:", error); return null; } },
            fetchSiteStatsIfNeeded: async (forceRefresh = false) => { if (!App.state.siteStats || forceRefresh) { try { const res = await fetch(`${App.config.workerUrl}/api/stats`); App.state.siteStats = await res.json(); } catch (e) { console.error("Fetch stats error:", e); } } },
            fetchSearchResults: async (query) => { try { const res = await fetch(`${App.config.workerUrl}/api/search?q=${encodeURIComponent(query)}`); return await res.json(); } catch (e) { console.error("Search error:", e); return []; } },
            handleSearchSubmit: (event) => { event.preventDefault(); const queryInput = event.target.querySelector('[name="query"]'); const query = queryInput.value.trim(); if (query) { window.location.hash = `#/search/${encodeURIComponent(query)}`; } },
            handleCommentSubmit: async (event, slug) => { event.preventDefault(); const form = event.target; const nickname = form.nickname.value.trim(); const content = form.content.value.trim(); if (!nickname || !content) { alert('昵称和内容不能为空!'); return; } try { const res = await fetch(`${App.config.workerUrl}/api/comments/${slug}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ nickname, content }) }); if (res.ok) { form.reset(); App.state.recentComments = []; App.state.siteStats = null; await App.fetchCommentsForPost(slug); App.router(); } else throw new Error('评论失败'); } catch (e) { alert('评论提交失败，请稍后再试。'); } },

            templates: {
                header: () => {
                    const renderSubMenuItems = (items) => { /* ... */ };
                     const renderTopLevelMenu = (items) => { /* ... */ };
                    const themeIcon = App.state.theme === 'light' ? `<i class="fal fa-moon h-5 w-5"></i>` : `<i class="fal fa-sun h-5 w-5"></i>`;
                    return `
                    <header class="sticky top-0 z-50 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
                        <div class="max-w-7xl mx-auto flex justify-between items-center h-[62px] px-4 sm:px-6 lg:px-8">
                            <div class="flex items-center gap-4">
                                <a href="#" class="text-xl font-bold text-gray-900 dark:text-gray-100 flex items-center gap-2">
                                    <i class="fas fa-cat text-2xl"></i>
                                    <span>夏商记</span>
                                </a>
                                 ${renderTopLevelMenu(App.state.navItems)}
                            </div>
                            <div class="flex items-center gap-[6px] text-gray-600 dark:text-gray-300">
                               <button id="search-toggle" onclick="document.getElementById('sidebar-search-input')?.focus()" class="p-[0.16rem] rounded-full hover:bg-gray-100 dark:hover:bg-gray-800">
                                    <i class="fal fa-search h-5 w-5"></i>
                               </button>
                               <button id="theme-toggle-button" onclick="App.toggleTheme()" class="p-[0.16rem] rounded-full hover:bg-gray-100 dark:hover:bg-gray-800">${themeIcon}</button>
                               <a href="admin.html" class="text-sm hover:underline">登录</a>
                            </div>
                        </div>
                    </header>`;
                },
                sidebar: () => { /* ... */ },
                footer: () => { /* ... */ },
                friendlyLinksSection: () => { /* ... */ },
                mainLayout: (content) => `<div class="flex-grow">${App.templates.header()}<main class="max-w-7xl mx-auto w-full p-4 sm:px-6 lg:py-8 flex flex-col lg:flex-row gap-[23px]"><div class="w-full lg:w-3/4">${content}</div>${App.templates.sidebar()}</main>${App.templates.friendlyLinksSection()}</div>${App.templates.footer()}`,
                carousel: () => { /* ... */ },
                homePage: (posts, title = "最新文章") => {
                    return `
                        ${App.templates.carousel()}
                        <div class="mt-[18px]">
                            <h1 class="text-[1.3rem] font-bold mb-2">${title}</h1>
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                                <div class="divide-y divide-gray-200 dark:divide-gray-700">
                                    ${posts.length > 0 ? posts.map(post => App.templates.postCard(post)).join('') : '<p class="p-6">没有找到相关文章。</p>'}
                                </div>
                            </div>
                        </div>
                    `;
                },
                postCard: (post) => { /* ... */ },
                postPage: (post) => { /* ... */ },
                commentForm: (slug) => { /* ... */ },
                commentsSection: (slug) => { /* ... */ },
                loader: () => `<div class="flex justify-center items-center py-20"><div class="loader"></div></div>`,
                notFoundPage: () => `<div class="text-center py-20"><h1 class="text-4xl font-bold">404</h1><p class="mt-4">页面不存在</p><a href="#" class="mt-6 inline-block bg-blue-500 text-white px-6 py-2 rounded">返回首页</a></div>`
            }
        };
        
        App.init();
    </script>
</body>
</html>
