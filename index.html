<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>我的博客</title>
    <link rel="stylesheet" href="https://gravatar.azure.cc/static/lib/fontawesome5pro/css/all.min.css?v=1.5.8">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sticky-sidebar-v2/dist/sticky-sidebar.min.js"></script>
    
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="app" class="app-container"></div>
    <div id="sidebar-container"></div>
    <div id="search-modal-container"></div>
    
    <button id="back-to-top" class="hidden">
      <i class="far fa-arrow-up"></i>
    </button>

    <script src="main.js"></script>

    <script>
        // NOTE: The main App object from your original file is used here.
        // I have replaced the 'class' attributes in the templates below.

        Object.assign(App.state, {
            posts: [],
            tags: [],
            categories: {},
            recentPosts: [],
            recentComments: [],
            comments: {}, 
            carouselData: null,
            desktopSidebar: null,
        });

        Object.assign(App.helpers, {
            stripHtmlAndTruncate: (html, length) => { const doc = new DOMParser().parseFromString(html, 'text/html'); const text = doc.body.textContent || ""; return text.length > length ? text.substring(0, length) + '...' : text; },
        });

        App.init = function() {
            this.applyTheme();
            this.renderMobileSidebar();
            this.renderSearchModal();
            window.addEventListener('hashchange', () => this.router());
            window.addEventListener('load', () => this.router());
            window.addEventListener('scroll', () => this.handleScroll());
        };

        App.initSwiper = function() { if (document.querySelector('.swiper')) { new Swiper('.swiper', { loop: true, autoplay: { delay: 5000 }, pagination: { el: '.swiper-pagination', clickable: true }, navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' } }); } };
        App.initStickySidebar = function() { const el = document.querySelector('.sidebar-column'); if(el && window.innerWidth >= 1024) { new StickySidebar(el, { topSpacing: 80, bottomSpacing: 20 }); }};
        
        App.router = async function() {
            const appContainer = document.getElementById('app');
            // ... (rest of router logic is identical to your original file)
            const path = window.location.hash.slice(1) || '/';
            const parts = path.split('/');
            await Promise.all([ this.fetchNavIfNeeded(), this.fetchTagsIfNeeded(), this.fetchFriendlyLinksIfNeeded(), this.fetchRecentCommentsIfNeeded(), this.fetchSiteStatsIfNeeded(), this.fetchCarouselDataIfNeeded(), this.fetchSiteSettingsIfNeeded() ]);
            await this.fetchDataIfNeeded();
            
            if (path === '/') {
                appContainer.innerHTML = this.templates.mainLayout(this.templates.homePage(this.state.posts));
                this.initSwiper();
            } else if (parts[1] === 'post' && parts[2]) {
                const slug = parts[2];
                const post = await this.fetchSinglePost(slug);
                await this.fetchCommentsForPost(slug);
                if (post) { const postIndex = this.state.posts.findIndex(p => p.slug === slug); if (postIndex > -1) this.state.posts[postIndex] = post; else this.state.posts.unshift(post); }
                appContainer.innerHTML = this.templates.mainLayout(this.templates.postPage(post));
            } else if (['search', 'category', 'tag'].includes(parts[1])) {
                let results = []; let title = "文章列表";
                if(parts[1] === 'search' && parts[2]) { const query = decodeURIComponent(parts[2]); results = await this.fetchSearchResults(query); title = `搜索: "${query}"`; }
                else if (parts[1] === 'category') { const categoryName = decodeURIComponent(parts[2]); results = this.state.posts.filter(p => p.category === categoryName); title = `分类: ${categoryName}`; }
                else if (parts[1] === 'tag' && parts[2]) { const tagName = decodeURIComponent(parts[2]); results = this.state.posts.filter(p => p.tags.includes(tagName)); title = `标签: ${tagName}`; }
                appContainer.innerHTML = this.templates.mainLayout(this.templates.homePage(results, title));
                this.initSwiper();
            }
            this.initStickySidebar();
            this.renderMobileSidebar();
        };
        
        // --- Data Fetching methods are identical to your original file ---
        App.fetchDataIfNeeded = async function(forceRefresh = false) { if (this.state.posts.length === 0 || forceRefresh) try { const res = await fetch(`${this.config.workerUrl}/api/posts`); const posts = await res.json(); this.state.posts = posts; this.state.categories = posts.reduce((acc, p) => ({...acc, [p.category]:(acc[p.category]||0)+1}), {}); this.state.recentPosts = posts.slice(0, 5); } catch (e) {} };
        App.fetchTagsIfNeeded = async function() { if (this.state.tags.length === 0) try { const res = await fetch(`${this.config.workerUrl}/api/tags`); this.state.tags = await res.json(); } catch (e) {} };
        App.fetchRecentCommentsIfNeeded = async function(forceRefresh = false) { if (this.state.recentComments.length === 0 || forceRefresh) try { const res = await fetch(`${this.config.workerUrl}/api/comments/recent`); this.state.recentComments = await res.json(); } catch (e) {} };
        App.fetchCommentsForPost = async function(slug) { try { const res = await fetch(`${this.config.workerUrl}/api/comments/${slug}`); this.state.comments[slug] = await res.json(); } catch (e) { this.state.comments[slug] = []; } };
        App.fetchSinglePost = async function(slug) { try { const response = await fetch(`${this.config.workerUrl}/api/posts/${slug}`); return await response.json(); } catch (error) { return null; } };
        App.fetchSearchResults = async function(query) { try { const res = await fetch(`${this.config.workerUrl}/api/search?q=${encodeURIComponent(query)}`); return await res.json(); } catch (e) { return []; } };
        App.fetchCarouselDataIfNeeded = async function() { if (!this.state.carouselData) try { const res = await fetch(`${this.config.workerUrl}/api/carousel`); this.state.carouselData = await res.json(); } catch (e) {} };

        // --- Rewritten Templates with Semantic Classes ---
        Object.assign(App.templates, {
            mainLayout: (content) => `<div class="main-content-area">${App.templates.header()}<main class="container"><div class="main-layout"><div class="content-column">${content}</div><aside class="sidebar-column">${App.templates.desktopSidebar()}</aside></div></main>${App.templates.friendlyLinksSection()}</div>${App.templates.footer()}`,
            desktopSidebar: () => (App.state.siteSettings?.sidebarModules || []).filter(m => m.enabled).map(m => App.templates.sidebarModules[m.id] ? App.templates.sidebarModules[m.id]() : '').join(''),
            sidebarModules: {
                search: () => `<div class="sidebar-widget"><form onsubmit="App.handleSearchSubmit(event)"><input type="search" name="query" placeholder="搜索..." class="form-input"></form></div>`,
                stats: () => `<div class="sidebar-widget"><h3 class="sidebar-widget-title">网站统计</h3><ul><li>文章总数: ${App.state.siteStats?.posts_total||0}</li><li>分类总数: ${App.state.siteStats?.categories_total||0}</li><li>评论总数: ${App.state.siteStats?.comments_total||0}</li></ul></div>`,
                recentPosts: () => `<div class="sidebar-widget"><h3 class="sidebar-widget-title">近期文章</h3><ul>${App.state.recentPosts.map(p=>`<li><a href="#/post/${p.slug}" class="recent-post-item"><img src="${p.imageUrl||'https://placehold.co/100x75/e2e8f0/cbd5e0?text=Img'}"><div>${p.isPinned?'<span class="pinned-tag">[置顶]</span> ':''}${p.title}</div></a></li>`).join('')}</ul></div>`,
                categories: () => `<div class="sidebar-widget"><h3 class="sidebar-widget-title">分类目录</h3><ul>${Object.entries(App.state.categories).map(([c,n])=>`<li><a href="#/category/${encodeURIComponent(c)}">${c} (${n})</a></li>`).join('')}</ul></div>`,
                tags: () => `<div class="sidebar-widget"><h3 class="sidebar-widget-title">标签</h3><div class="tag-list">${App.state.tags.map(t=>`<a href="#/tag/${encodeURIComponent(t)}">${t}</a>`).join('')}</div></div>`,
                recentComments: () => `<div class="sidebar-widget"><h3 class="sidebar-widget-title">最近评论</h3><ul>${(App.state.recentComments||[]).map(c=>`<li><b>${c.nickname}</b> on <a href="#/post/${c.slug}">${c.postTitle}</a></li>`).join('')}</ul></div>`,
            },
            carousel: () => `<div class="swiper"><div class="swiper-wrapper">${(App.state.carouselData?.slides||[]).map(s=>`<div class="swiper-slide"><a href="${s.linkUrl}"><img src="${s.imageUrl}"></a></div>`).join('')}</div><div class="swiper-pagination"></div><div class="swiper-button-prev"></div><div class="swiper-button-next"></div></div>`,
            homePage: (posts, title = "最新文章") => `${App.templates.carousel()}<div class="card" style="margin-top: 1.5rem;"><h1 class="sidebar-widget-title">${title}</h1><div class="post-card-list">${posts.length > 0 ? posts.map(p => App.templates.postCard(p)).join('') : '<p>没有找到相关文章。</p>'}</div></div>`,
            postCard: (post) => `<div class="post-card"><a href="#/post/${post.slug}" class="post-card-thumbnail"><img src="${post.imageUrl || 'https://placehold.co/400x300/e2e8f0/cbd5e0?text=Image'}"><span class="post-card-category">${post.category}</span></a><div class="post-card-info"><div><h2 class="post-card-title"><a href="#/post/${post.slug}">${post.isPinned ? '<span class="pinned-tag">[置顶]</span> ' : ''}${post.title}</a></h2><p class="post-card-excerpt">${App.helpers.stripHtmlAndTruncate(post.content, 100)}</p></div><div class="post-card-meta"><span>${new Date(post.date).toLocaleDateString()}</span><div class="post-card-meta-views"><i class="fas fa-eye"></i><span>${post.views || 0}</span></div></div></div></div>`,
        });

        App.init();
    </script>
</body>
</html>
