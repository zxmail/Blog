<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的博客</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .ql-editor { min-height: 250px; font-size: 16px; line-height: 1.7; }
        .content-area { font-size: 16px; line-height: 1.7; }
        .content-area a { color: #3b82f6; text-decoration: underline; }
        .content-area h1, .content-area h2, .content-area h3 { font-weight: 600; margin-top: 1.5em; margin-bottom: 0.5em; border: none; padding: 0;}
        .content-area h1 { font-size: 2em; } .content-area h2 { font-size: 1.5em; } .content-area h3 { font-size: 1.25em; }
        .content-area p { margin-bottom: 1em; } .content-area ul, .content-area ol { padding-left: 2em; margin-bottom: 1em; }
        .content-area blockquote { border-left: 4px solid #e5e7eb; padding-left: 1em; margin-left: 0; color: #6b7280; }
        .content-area pre { background-color: #f3f4f6; padding: 1em; border-radius: 0.5rem; overflow-x: auto; color: #1f2937; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8"></div>

    <script>
        const App = {
            config: {
                workerUrl: 'https://blog.xy193.workers.dev'
            },
            state: {
                posts: [],
                navItems: [],
                categories: {},
                recentPosts: [],
                authToken: localStorage.getItem('authToken'),
                editorInstance: null
            },

            init() {
                window.addEventListener('hashchange', this.router);
                window.addEventListener('load', this.router);
            },
            
            helpers: {
                stripHtmlAndTruncate(html, length) {
                    const doc = new DOMParser().parseFromString(html, 'text/html');
                    const text = doc.body.textContent || "";
                    return text.length > length ? text.substring(0, length) + '...' : text;
                }
            },

            router: async () => {
                const appContainer = document.getElementById('app');
                appContainer.innerHTML = App.templates.loader();

                const path = window.location.hash.slice(1) || '/';
                const parts = path.split('/');

                // 并行获取导航和文章数据
                await Promise.all([
                    App.fetchNavIfNeeded(),
                    App.fetchDataIfNeeded()
                ]);

                if (path === '/') {
                    appContainer.innerHTML = App.templates.mainLayout(App.templates.homePage(App.state.posts));
                } else if (parts[1] === 'post' && parts[2]) {
                    const slug = parts[2];
                    const post = App.state.posts.find(p => p.slug === slug);
                    appContainer.innerHTML = App.templates.mainLayout(App.templates.postPage(post));
                } else if (parts[1] === 'category' && parts[2]) {
                    const categoryName = decodeURIComponent(parts[2]);
                    const filteredPosts = App.state.posts.filter(p => p.category === categoryName);
                    appContainer.innerHTML = App.templates.mainLayout(App.templates.homePage(filteredPosts, `分类: ${categoryName}`));
                } else if (path === '/admin') {
                    if (App.state.authToken) {
                        window.location.hash = '/admin/dashboard';
                    } else {
                        appContainer.innerHTML = App.templates.loginPage();
                    }
                } else if (path === '/admin/dashboard') {
                    if (!App.state.authToken) { window.location.hash = '/admin'; return; }
                    appContainer.innerHTML = App.templates.adminDashboard();
                } else {
                    appContainer.innerHTML = App.templates.mainLayout(App.templates.notFoundPage());
                }
            },
            
            fetchNavIfNeeded: async () => {
                if (App.state.navItems.length === 0) {
                     try {
                        const response = await fetch(`${App.config.workerUrl}/api/nav`);
                        if (!response.ok) throw new Error('Failed to fetch nav');
                        App.state.navItems = await response.json();
                    } catch (error) {
                        console.error("Fetch nav error:", error);
                        App.state.navItems = [{ label: '首页', url: '#/' }]; // Fallback
                    }
                }
            },
            fetchDataIfNeeded: async () => {
                if (App.state.posts.length === 0) {
                    try {
                        const response = await fetch(`${App.config.workerUrl}/api/posts`);
                        if (!response.ok) throw new Error('Failed to fetch posts');
                        const posts = await response.json();
                        App.state.posts = posts;
                        const categories = {};
                        posts.forEach(post => {
                            categories[post.category] = (categories[post.category] || 0) + 1;
                        });
                        App.state.categories = categories;
                        App.state.recentPosts = posts.slice(0, 5);
                    } catch (error) {
                        console.error("Fetch posts error:", error);
                    }
                }
            },

            handleLogin: async (event) => { /* ... no changes from previous version ... */ 
                 event.preventDefault();
                const username = event.target.username.value;
                const password = event.target.password.value;
                const submitButton = event.target.querySelector('button');
                const errorMessage = document.getElementById('error-message');
                submitButton.disabled = true;
                submitButton.textContent = '登录中...';

                try {
                    const response = await fetch(`${App.config.workerUrl}/api/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password }),
                    });
                    const data = await response.json();
                    if (data.success) {
                        App.state.authToken = data.token;
                        localStorage.setItem('authToken', data.token);
                        window.location.hash = '/admin/dashboard';
                    } else {
                        errorMessage.textContent = '用户名或密码错误。';
                        errorMessage.classList.remove('hidden');
                    }
                } catch (error) {
                    errorMessage.textContent = '登录失败，请稍后重试。';
                    errorMessage.classList.remove('hidden');
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = '登录';
                }
            },
            handleLogout: () => { /* ... no changes from previous version ... */ 
                App.state.authToken = null;
                localStorage.removeItem('authToken');
                window.location.hash = '/admin';
            },

            // --- UI切换函数 ---
            showView: (viewName, param = null) => {
                const contentArea = document.getElementById('admin-content');
                if (viewName === 'posts') {
                    contentArea.innerHTML = App.templates.postManager();
                } else if (viewName === 'editor') {
                    const post = param ? App.state.posts.find(p => p.slug === param) : {};
                    contentArea.innerHTML = App.templates.postEditor(post);
                    App.initEditor(post);
                } else if (viewName === 'nav') {
                    contentArea.innerHTML = App.templates.navEditor();
                }
            },
            
            initEditor: (post = {}) => {
                App.state.editorInstance = new Quill('#editor', {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            [{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline', 'strike'], ['blockquote', 'code-block'],
                            [{'list': 'ordered'}, {'list': 'bullet'}], [{'indent': '-1'}, {'indent': '+1'}], ['link', 'image'], ['clean']
                        ]
                    }
                });
                if (post.content) App.state.editorInstance.root.innerHTML = post.content;
            },

            // --- 表单提交处理 ---
            handlePostFormSubmit: async (event) => { /* ... no changes from previous version ... */ 
                 event.preventDefault();
                const form = event.target;
                const slug = form.dataset.slug;
                const isEditing = !!slug;
                const method = isEditing ? 'PUT' : 'POST';
                const url = isEditing ? `${App.config.workerUrl}/api/admin/posts/${slug}` : `${App.config.workerUrl}/api/admin/posts`;
                
                const postData = {
                    title: form.title.value,
                    category: form.category.value,
                    imageUrl: form.imageUrl.value,
                    content: App.state.editorInstance.root.innerHTML,
                    date: isEditing ? form.dataset.date : null
                };

                try {
                    const response = await fetch(url, {
                        method,
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${App.state.authToken}` },
                        body: JSON.stringify(postData)
                    });
                    if (response.ok) {
                        alert('文章保存成功!');
                        App.state.posts = [];
                        window.location.hash = '/admin/dashboard';
                    } else { throw new Error('保存失败'); }
                } catch (error) {
                    console.error('Error saving post:', error);
                    alert('文章保存失败。');
                }
            },
            deletePost: async (slug) => { /* ... no changes from previous version ... */ 
                if (!confirm('确定要删除这篇文章吗？')) return;
                try {
                    const response = await fetch(`${App.config.workerUrl}/api/admin/posts/${slug}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${App.state.authToken}` }
                    });
                    if (response.ok) {
                        alert('删除成功!');
                        App.state.posts = [];
                        App.router();
                    } else { throw new Error('删除失败'); }
                } catch (error) {
                    alert('删除失败。');
                }
            },
            
            // --- 导航菜单管理 ---
            addNavItemRow: () => {
                const container = document.getElementById('nav-item-list');
                const div = document.createElement('div');
                div.className = 'nav-item-row flex items-center gap-2 mb-2';
                div.innerHTML = `
                    <input type="text" name="label" placeholder="菜单项名称" class="flex-1 px-3 py-2 border border-gray-300 rounded-md">
                    <input type="text" name="url" placeholder="URL (例如: #/category/分类名)" class="flex-1 px-3 py-2 border border-gray-300 rounded-md">
                    <button type="button" onclick="App.removeNavItemRow(this)" class="bg-red-500 text-white px-3 py-2 rounded-md hover:bg-red-600">-</button>
                `;
                container.appendChild(div);
            },
            removeNavItemRow: (button) => {
                button.closest('.nav-item-row').remove();
            },
            handleNavFormSubmit: async (event) => {
                event.preventDefault();
                const rows = document.querySelectorAll('.nav-item-row');
                const newNavItems = Array.from(rows).map(row => ({
                    label: row.querySelector('input[name="label"]').value,
                    url: row.querySelector('input[name="url"]').value
                })).filter(item => item.label && item.url);

                try {
                    const response = await fetch(`${App.config.workerUrl}/api/admin/nav`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${App.state.authToken}` },
                        body: JSON.stringify(newNavItems)
                    });
                    if (response.ok) {
                        alert('导航菜单已更新!');
                        App.state.navItems = []; // 清空缓存以便下次刷新
                        window.location.hash = '/admin/dashboard';
                    } else { throw new Error('更新失败'); }
                } catch (error) {
                    alert('导航菜单更新失败。');
                }
            },
            
            templates: {
                header: () => `
                    <header class="flex justify-between items-center py-4 border-b border-gray-200 mb-8">
                        <a href="#" class="text-2xl font-bold text-gray-900">夏商记</a>
                        <nav class="hidden sm:flex items-center space-x-6 text-gray-600">
                            ${App.state.navItems.map(item => `<a href="${item.url}" class="hover:text-blue-500">${item.label}</a>`).join('')}
                            <a href="#/admin" class="hover:text-blue-500">管理后台</a>
                        </nav>
                    </header>
                `,
                sidebar: () => `... (与之前相同)`,
                mainLayout: (content) => `... (与之前相同)`,
                homePage: (posts, title = "所有文章") => `
                    <h1 class="text-2xl font-bold mb-6">${title}</h1>
                    <div class="space-y-8">
                        ${posts.length > 0 ? posts.map(post => App.templates.postCard(post)).join('') : '<p>这里还没有文章。</p>'}
                    </div>
                `,
                postCard: (post) => `
                    <article class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex flex-col sm:flex-row items-center gap-6">
                        <a href="#/post/${post.slug}" class="block w-full sm:w-1/3 lg:w-1/4 flex-shrink-0">
                            <img src="${post.imageUrl || 'https://placehold.co/400x300/e2e8f0/cbd5e0?text=Image'}" alt="${post.title}" class="rounded-md w-full h-48 sm:h-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x300/e2e8f0/cbd5e0?text=Image';">
                        </a>
                        <div class="flex-grow">
                            <div class="flex items-center text-sm text-gray-500 mb-2">
                                <a href="#/category/${encodeURIComponent(post.category)}" class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-xs font-semibold hover:bg-blue-200">${post.category}</a>
                                <span class="mx-2">&middot;</span>
                                <span>${new Date(post.date).toLocaleDateString()}</span>
                            </div>
                            <h2 class="text-xl font-bold mb-2"><a href="#/post/${post.slug}" class="text-gray-900 hover:text-blue-600">${post.title}</a></h2>
                            <div class="text-gray-600 leading-relaxed text-sm">${App.helpers.stripHtmlAndTruncate(post.content, 120)}</div>
                        </div>
                    </article>
                `,
                postPage: (post) => `... (与之前相同)`,
                loginPage: () => `... (与之前相同)`,
                adminDashboard: () => `
                    <header class="flex justify-between items-center py-4 border-b border-gray-200 mb-8">
                        <h1 class="text-2xl font-bold">管理后台</h1>
                        <div>
                            <a href="#" class="text-blue-500 hover:underline mr-4">返回博客</a>
                            <button onclick="App.handleLogout()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">退出</button>
                        </div>
                    </header>
                    <div class="flex gap-6">
                        <aside class="w-1/5">
                            <ul class="space-y-2">
                                <li><button onclick="App.showView('posts')" class="w-full text-left font-semibold p-2 rounded hover:bg-gray-200">文章管理</button></li>
                                <li><button onclick="App.showView('nav')" class="w-full text-left font-semibold p-2 rounded hover:bg-gray-200">导航设置</button></li>
                            </ul>
                        </aside>
                        <main id="admin-content" class="w-4/5">
                            ${App.templates.postManager()}
                        </main>
                    </div>
                `,
                postManager: () => `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold">文章列表</h2>
                        <button onclick="App.showView('editor')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">撰写新文章</button>
                    </div>
                    <div class="bg-white shadow rounded-lg overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50"><tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">标题</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">分类</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">日期</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">操作</th>
                            </tr></thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${App.state.posts.map(post => `<tr>
                                    <td class="px-6 py-4 text-sm font-medium text-gray-900">${post.title}</td>
                                    <td class="px-6 py-4 text-sm text-gray-500">${post.category}</td>
                                    <td class="px-6 py-4 text-sm text-gray-500">${new Date(post.date).toLocaleDateString()}</td>
                                    <td class="px-6 py-4 text-right text-sm font-medium space-x-2">
                                        <button onclick="App.showView('editor', '${post.slug}')" class="text-indigo-600 hover:text-indigo-900">编辑</button>
                                        <button onclick="App.deletePost('${post.slug}')" class="text-red-600 hover:text-red-900">删除</button>
                                    </td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                `,
                postEditor: (post = {}) => `... (与之前相同)`,
                navEditor: () => `
                    <h2 class="text-xl font-semibold mb-6">导航菜单设置</h2>
                    <form onsubmit="App.handleNavFormSubmit(event)" class="bg-white p-6 rounded-lg shadow">
                        <div id="nav-item-list" class="space-y-2 mb-4">
                            ${App.state.navItems.map(item => `
                                <div class="nav-item-row flex items-center gap-2">
                                    <input type="text" name="label" placeholder="菜单项名称" value="${item.label}" class="flex-1 px-3 py-2 border border-gray-300 rounded-md">
                                    <input type="text" name="url" placeholder="URL (例如: #/category/分类名)" value="${item.url}" class="flex-1 px-3 py-2 border border-gray-300 rounded-md">
                                    <button type="button" onclick="App.removeNavItemRow(this)" class="bg-red-500 text-white px-3 py-2 rounded-md hover:bg-red-600">-</button>
                                </div>
                            `).join('')}
                        </div>
                        <button type="button" onclick="App.addNavItemRow()" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded mb-4">+ 添加菜单项</button>
                        <div class="text-right border-t pt-4">
                            <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">保存菜单设置</button>
                        </div>
                    </form>
                `,
                loader: () => `... (与之前相同)`,
                notFoundPage: () => `... (与之前相同)`
            }
        };

        // 为了简洁，部分未变的模板函数被折叠了，实际代码是完整的
        App.templates.sidebar = () => `...`;
        App.templates.mainLayout = (content) => `${App.templates.header()}<main class="flex flex-col lg:flex-row gap-8 lg:gap-12"><div class="w-full lg:w-3/4">${content}</div>${App.templates.sidebar()}</main>`;
        App.templates.postPage = (post) => post ? `<article class="bg-white p-6 sm:p-8 rounded-lg shadow-sm border border-gray-200"><div class="flex items-center text-sm text-gray-500 mb-2"><span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-xs font-semibold">${post.category}</span><span class="mx-2">&middot;</span><span>发布于 ${new Date(post.date).toLocaleDateString()}</span></div><h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-6">${post.title}</h1>${post.imageUrl ? `<img src="${post.imageUrl}" alt="${post.title}" class="w-full rounded-lg mb-8">` : ''}<div class="content-area text-gray-700">${post.content}</div></article>` : App.templates.notFoundPage();
        App.templates.loginPage = () => `<div class="min-h-screen flex items-center justify-center bg-gray-50"><div class="max-w-md w-full bg-white p-8 rounded-lg shadow-md"><h2 class="text-2xl font-bold text-center text-gray-800 mb-6">管理员登录</h2><form onsubmit="App.handleLogin(event)"><div class="mb-4"><label for="username" class="block text-sm font-medium text-gray-700">用户名</label><input type="text" id="username" name="username" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div><div class="mb-6"><label for="password" class="block text-sm font-medium text-gray-700">密码</label><input type="password" id="password" name="password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div><p id="error-message" class="text-red-500 text-sm mb-4 hidden"></p><div><button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">登录</button></div><p class="text-center mt-4"><a href="#" class="text-blue-500 hover:underline text-sm">返回首页</a></p></form></div></div>`;
        App.templates.postEditor = (post = {}) => `<div class="flex justify-between items-center mb-6"><h2 class="text-xl font-semibold">${post.slug ? '编辑文章' : '撰写新文章'}</h2><button onclick="App.showView('posts')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">返回列表</button></div><form onsubmit="App.handlePostFormSubmit(event)" data-slug="${post.slug || ''}" data-date="${post.date || ''}" class="bg-white p-6 rounded-lg shadow space-y-6"><div><label for="title" class="block text-sm font-medium text-gray-700">标题</label><input type="text" id="title" name="title" value="${post.title || ''}" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label for="category" class="block text-sm font-medium text-gray-700">分类</label><input type="text" id="category" name="category" value="${post.category || ''}" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div><div><label for="imageUrl" class="block text-sm font-medium text-gray-700">配图 URL</label><input type="url" id="imageUrl" name="imageUrl" value="${post.imageUrl || ''}" placeholder="https://example.com/image.jpg" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div></div><div><label class="block text-sm font-medium text-gray-700 mb-1">内容</label><div id="editor" class="bg-white"></div></div><div class="text-right"><button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">保存文章</button></div></form>`;
        App.templates.loader = () => `<div class="flex justify-center items-center py-20"><div class="loader"></div></div>`;
        App.templates.notFoundPage = () => `<div class="text-center py-20"><h1 class="text-4xl font-bold">404 - Not Found</h1><p class="mt-4 text-gray-600">抱歉，您要找的页面不存在。</p><a href="#" class="mt-6 inline-block bg-blue-500 text-white px-6 py-2 rounded-lg">返回首页</a></div>`;
        App.templates.sidebar = () => `<aside class="w-full lg:w-1/4 space-y-8"><div><h3 class="font-semibold text-lg border-b pb-2 mb-4">近期文章</h3><ul class="space-y-3">${App.state.recentPosts.map(post => `<li><a href="#/post/${post.slug}" class="text-gray-700 hover:text-blue-600 text-sm flex items-start"><span class="text-gray-400 mr-2 mt-1">&#8227;</span><span>${post.title}</span></a></li>`).join('')}</ul></div><div><h3 class="font-semibold text-lg border-b pb-2 mb-4">分类目录</h3><ul class="space-y-3">${Object.entries(App.state.categories).map(([category, count]) => `<li><a href="#/category/${encodeURIComponent(category)}" class="text-gray-700 hover:text-blue-600 text-sm flex justify-between"><span>${category}</span><span>(${count})</span></a></li>`).join('')}</ul></div></aside>`;

        App.init();
    </script>
</body>
</html>

