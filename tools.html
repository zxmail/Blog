<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>在线工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://gravatar.azure.cc/static/lib/fontawesome5pro/css/all.min.css?v=1.5.8">
    
    <script src="https://cdn.jsdelivr.net/npm/qr-code-styling/lib/qr-code-styling.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sticky-sidebar-v2/dist/sticky-sidebar.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/otpauth@9.1.4/dist/otpauth.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pinyin-pro@3.18.4/dist/pinyin-pro.js"></script>
    
    <link rel="stylesheet" href="style.css">

    <script>
        tailwind.config = { darkMode: 'class' };
    </script>
</head>
<body class="text-gray-800 dark:text-gray-200">

    <div id="app" class="flex flex-col min-h-screen"></div>
    <div id="sidebar-container"></div>
    <div id="search-modal-container"></div>
    
    <button id="back-to-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="shadow-lg flex items-center justify-center">
      <i class="far fa-arrow-up"></i>
    </button>

    <div id="toast-container" class="fixed top-5 right-5 z-50"></div>

    <div id="qrcode-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4" onclick="App.closeQrCodeModal()">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-xs text-center relative" onclick="event.stopPropagation()">
            <button onclick="App.closeQrCodeModal()" class="absolute top-2 right-3 text-gray-500 hover:text-gray-800 dark:text-gray-300 dark:hover:text-white text-2xl font-light">&times;</button>
            <h3 class="text-lg font-semibold mb-4">扫描二维码</h3>
            <div id="qrcode-canvas" class="flex justify-center p-2 bg-white rounded-md"></div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-4">可以使用Google Authenticator扫描上方二维码把密钥添加至手机。</p>
        </div>
    </div>


    <script src="main.js"></script>

    <script>
        const pageTools = [
            { id: '2fa', name: '2FA工具', icon: 'fas fa-shield-check', template: 'tool2FAContent' },
            { id: 'qrcode', name: '在线生成二维码', icon: 'fas fa-qrcode', template: 'toolQRCodeContent' },
            { id: 'text', name: '文本处理', icon: 'fas fa-file-alt', template: 'toolTextProcessingContent' },
            { id: 'image', name: '图片处理', icon: 'fas fa-image', template: 'toolComingSoonContent' },
            { id: 'more', name: '更多工具', icon: 'fas fa-ellipsis-h', template: 'toolComingSoonContent' }
        ];

        Object.assign(App.state, {
            tools: pageTools,
            activeToolId: pageTools[0].id,
            desktopSidebar: null,
            twoFaTimer: null,
            currentTotpObject: null,
            qrCodeInstance: null 
        });

        // NEW: Text processing utility functions
        App.textUtils = {
            init: function() {
                this.input = document.getElementById('text-input');
                this.output = document.getElementById('text-output');
                this.stats = document.getElementById('text-stats');
                this.loadCache();
                this.updateStats();
            },
            updateStats: function() {
                if (!this.input || !this.stats) return;
                const lines = this.input.value ? this.input.value.split('\n').length : 0;
                const chars = this.input.value.length;
                const selected = this.input.selectionEnd - this.input.selectionStart;
                this.stats.textContent = `输入信息:[${lines}]行,[${chars}]字,已选中[${selected}]字`;
            },
            saveCache: function() {
                if (!this.input) return;
                localStorage.setItem('textToolInputCache', this.input.value);
                this.updateStats();
            },
            loadCache: function() {
                if (!this.input) return;
                this.input.value = localStorage.getItem('textToolInputCache') || '';
            },
            clearAll: function() {
                this.input.value = '';
                this.output.value = '';
                localStorage.removeItem('textToolInputCache');
                this.updateStats();
            },
            download: function(filename, content) {
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            },
            copyResult: function() {
                if (!this.output.value) return;
                navigator.clipboard.writeText(this.output.value)
                    .then(() => App.showToast("复制成功", "结果已复制到剪贴板"))
                    .catch(() => alert("复制失败"));
            },
            resultToInput: function() { this.input.value = this.output.value; this.saveCache(); },
            // --- Processing Functions ---
            process: function(fn) { try { this.output.value = fn(this.input.value); } catch(e) { this.output.value = '处理时发生错误: ' + e.message; } },
            base64Encode: function() { this.process(str => btoa(unescape(encodeURIComponent(str)))); },
            base64Decode: function() { this.process(str => decodeURIComponent(escape(atob(str)))); },
            toUpperCase: function() { this.process(str => str.toUpperCase()); },
            toLowerCase: function() { this.process(str => str.toLowerCase()); },
            capitalizeFirst: function() { this.process(str => str.charAt(0).toUpperCase() + str.slice(1).toLowerCase()); },
            hanziToPinyin: function() { this.process(str => pinyinPro.pinyin(str, { toneType: 'none' })); },
            stripHtml: function() { this.process(str => str.replace(/<[^>]*>/g, '')); },
            htmlEntities: function() { this.process(str => str.replace(/[\u00A0-\u9999<>\&]/g, i => '&#' + i.charCodeAt(0) + ';')); },
            clearBlankLines: function() { this.process(str => str.replace(/^\s*[\r\n]/gm, '')); },
            mergeLines: function() { this.process(str => str.replace(/\n+/g, ' ').trim()); }
        };

        App.init = function() {
            this.applyTheme();
            this.renderMobileSidebar();
            this.renderSearchModal();
            window.addEventListener('hashchange', () => this.router());
            window.addEventListener('load', () => this.router());
            window.addEventListener('scroll', () => this.handleScroll());
            window.addEventListener('resize', () => this.initStickySidebar());
        };

        App.initStickySidebar = function() {
            const sidebarElement = document.querySelector('#tools-sidebar-wrapper');
            if (sidebarElement && window.innerWidth >= 1024) {
                if (this.state.desktopSidebar) this.state.desktopSidebar.destroy();
                this.state.desktopSidebar = new StickySidebar('#tools-sidebar-wrapper', {
                    topSpacing: 80, bottomSpacing: 20,
                    containerSelector: '.main-container', innerWrapperSelector: '.sidebar-inner-wrapper'
                });
            } else if (this.state.desktopSidebar) {
                this.state.desktopSidebar.destroy();
                this.state.desktopSidebar = null;
            }
        };
        
        App.handleGenerateQRCode = function() {
             // ... function from previous turn ...
        };
        
        // ... (All other functions like openQrCodeModal, handle2FAGenerate, etc. remain unchanged)
        // ... (The full code for these functions is included below for completeness)
        App.openQrCodeModal = function() { if (!this.state.currentTotpObject) { alert('请先输入有效的密钥并点击“点击获取验证码”！'); return; } const qrCanvas = document.getElementById('qrcode-canvas'); qrCanvas.innerHTML = ''; const uri = this.state.currentTotpObject.toString(); const qrCode = new QRCodeStyling({ width: 220, height: 220, data: uri, margin: 5, qrOptions: { errorCorrectionLevel: 'M' }, }); qrCode.append(qrCanvas); document.getElementById('qrcode-modal').style.display = 'flex'; };
        App.closeQrCodeModal = function() { document.getElementById('qrcode-modal').style.display = 'none'; };
        App.handle2FAGenerate = function() { if (this.state.twoFaTimer) clearInterval(this.state.twoFaTimer); this.state.currentTotpObject = null; const secretInput = document.getElementById('2fa-secret'); const secret = secretInput.value.trim().replace(/\s/g, ''); if (!secret) { document.getElementById('2fa-code').textContent = '请输入密钥！'; document.getElementById('2fa-time').textContent = '--'; document.getElementById('2fa-secret-display').textContent = ''; return; } try { const totp = new OTPAuth.TOTP({ issuer: "2FA工具", label: secret.slice(0, 16), algorithm: "SHA1", digits: 6, period: 30, secret: OTPAuth.Secret.fromBase32(secret), }); this.state.currentTotpObject = totp; this.start2FATimer(totp); document.getElementById('2fa-secret-display').textContent = secret; } catch (error) { this.state.currentTotpObject = null; console.error("Error generating TOTP:", error); document.getElementById('2fa-code').textContent = '密钥错误'; document.getElementById('2fa-time').textContent = '0'; document.getElementById('2fa-secret-display').textContent = ''; } };
        App.start2FATimer = function(totp) { const update = () => { const token = totp.generate(); const remainingTime = totp.period - (Math.floor(Date.now() / 1000) % totp.period); document.getElementById('2fa-code').textContent = token; document.getElementById('2fa-time').textContent = remainingTime; if (remainingTime === 30 || !this.state.twoFaTimer) { navigator.clipboard.writeText(token).then(() => { this.showToast("已成功获取验证码哦~", "已成功复制"); }).catch(err => { console.error('Failed to copy: ', err); }); } }; update(); this.state.twoFaTimer = setInterval(update, 1000); };
        App.handleGenerateQRCode = function() { const text = document.getElementById('qr-text-input').value; const errorLevel = document.getElementById('qr-error-level').value; let totalSize = parseInt(document.getElementById('qr-size').value, 10); let marginInPx = parseInt(document.getElementById('qr-margin').value, 10); const outputDiv = document.getElementById('qr-code-output'); if (!text) { outputDiv.innerHTML = ''; this.state.qrCodeInstance = null; return; } if (isNaN(totalSize) || totalSize <= 20) totalSize = 80; if (isNaN(marginInPx) || marginInPx < 0) marginInPx = 0; const qrCodeSize = totalSize - (marginInPx * 2); if (qrCodeSize <= 0) { outputDiv.innerHTML = ''; this.state.qrCodeInstance = null; return; } outputDiv.style.padding = `${marginInPx}px`; outputDiv.style.backgroundColor = '#fff'; const options = { width: qrCodeSize, height: qrCodeSize, data: text, margin: 0, qrOptions: { errorCorrectionLevel: errorLevel }, dotsOptions: { color: "#000", type: "square" }, cornersSquareOptions: { type: "square" }, backgroundOptions: { color: "#fff" }, }; if (!this.state.qrCodeInstance) { this.state.qrCodeInstance = new QRCodeStyling(options); this.state.qrCodeInstance.append(outputDiv); } else { this.state.qrCodeInstance.update(options); } };

        App.router = async function() {
            if (this.state.twoFaTimer) clearInterval(this.state.twoFaTimer);
            this.state.currentTotpObject = null;
            this.state.qrCodeInstance = null;
            const appContainer = document.getElementById('app');
            const hash = window.location.hash.slice(1) || this.state.tools[0].id;
            const toolExists = this.state.tools.some(t => t.id === hash);
            this.state.activeToolId = toolExists ? hash : this.state.tools[0].id;
            await Promise.all([ 
                this.fetchNavIfNeeded(), 
                this.fetchFriendlyLinksIfNeeded(), 
                this.fetchSiteStatsIfNeeded(), 
                this.fetchSiteSettingsIfNeeded() 
            ]);
            appContainer.innerHTML = this.templates.mainLayout();
            document.title = this.state.tools.find(t => t.id === this.state.activeToolId)?.name + ' - 在线工具' || '在线工具';
            this.initStickySidebar();
            
            // Initialize the specific tool after rendering
            if (this.state.activeToolId === 'qrcode') {
                document.getElementById('qr-text-input').value = 'https://blog-9ce.pages.dev/';
                this.handleGenerateQRCode();
            } else if (this.state.activeToolId === 'text') {
                this.textUtils.init();
            }
            
            this.renderMobileSidebar();
        };

        Object.assign(App.templates, {
            mainLayout: () => `
                <div class="flex-grow">
                    ${App.templates.header()}
                    <main class="max-w-7xl mx-auto w-full p-4 sm:px-6">
                        <div class="flex flex-col lg:flex-row gap-6 main-container">
                            <div class="w-full lg:w-1/5 lg:max-w-[220px] flex-shrink-0" id="tools-sidebar-wrapper">
                                <div class="sidebar-inner-wrapper">
                                    ${App.templates.toolSidebar()}
                                </div>
                            </div>
                            <div class="w-full">
                                ${App.templates[App.state.tools.find(t => t.id === App.state.activeToolId).template]()}
                            </div>
                        </div>
                    </main>
                    ${App.templates.friendlyLinksSection()}
                </div>
                ${App.templates.footer()}
            `,
            toolSidebar: () => `
                <aside class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 tool-sidebar">
                    <div class="flex flex-row lg:flex-col items-center justify-center gap-4">
                        ${App.state.tools.map(tool => `
                            <a href="#${tool.id}" class="tool-item flex flex-col items-center justify-center gap-2 text-center w-20 ${tool.id === App.state.activeToolId ? 'active' : ''}">
                                <div class="tool-icon-wrapper w-14 h-14 bg-green-500 rounded-lg flex items-center justify-center shadow-md transition-transform duration-200 hover:scale-110 hover:shadow-lg">
                                    <i class="${tool.icon} text-white text-2xl"></i>
                                </div>
                                <span class="tool-label text-xs font-medium text-gray-600 dark:text-gray-400">${tool.name}</span>
                            </a>
                        `).join('')}
                    </div>
                </aside>
            `,
            // ... other tool templates (2FA, QR Code, Coming Soon)
            tool2FAContent: () => `...`, // Content from previous turns
            toolQRCodeContent: () => `...`, // Content from previous turns
            
            // NEW: Template for Text Processing Tool
            toolTextProcessingContent: () => `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                    <h2 class="text-xl font-semibold">文本处理</h2>
                    <p class="text-sm text-gray-500 mt-1">输入框(上)的内容改动会自动保存在本地缓存中，输出框(下)结果不会保存。</p>
                    
                    <div class="mt-6 flex flex-col md:flex-row gap-6">
                        <div class="w-full md:w-1/3 grid grid-cols-2 gap-3">
                            <button onclick="App.textUtils.loadCache()" class="p-2 text-sm border rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">加载本地缓存</button>
                            <button onclick="App.textUtils.clearAll()" class="p-2 text-sm border rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">清除全部内容</button>
                            <button onclick="App.textUtils.download('input.txt', App.textUtils.input.value)" class="p-2 text-sm border rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">导出输入文本</button>
                            <button onclick="App.textUtils.download('result.txt', App.textUtils.output.value)" class="p-2 text-sm border rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">导出结果文本</button>
                            <button onclick="App.textUtils.copyResult()" class="p-2 text-sm border rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">复制处理结果</button>
                            <button onclick="App.textUtils.resultToInput()" class="p-2 text-sm border rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">结果转到输入框</button>
                            <button onclick="alert('功能开发中')" class="p-2 text-sm border rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">替换或添加</button>
                            <button onclick="App.textUtils.htmlEntities()" class="p-2 text-sm border rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">HTML文本化</button>
                            <button onclick="App.textUtils.stripHtml()" class="p-2 text-sm border rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">清除HTML标签</button>
                            <button onclick="alert('功能开发中')" class="p-2 text-sm border rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">清除两行空格</button>
                            <button onclick="App.textUtils.clearBlankLines()" class="p-2 text-sm border rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">清除空白行</button>
                            <button onclick="App.textUtils.mergeLines()" class="p-2 text-sm border rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">合并多行</button>
                            <button onclick="App.textUtils.capitalizeFirst()" class="p-2 text-sm border rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">首字母大写</button>
                            <button onclick="App.textUtils.toUpperCase()" class="p-2 text-sm border rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">字母全部大写</button>
                            <button onclick="App.textUtils.toLowerCase()" class="p-2 text-sm border rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">字母全部小写</button>
                            <button onclick="App.textUtils.hanziToPinyin()" class="p-2 text-sm border rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">汉字转拼音</button>
                            <button onclick="alert('功能开发中')" class="p-2 text-sm border rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">表格导出</button>
                            <button onclick="alert('功能开发中')" class="p-2 text-sm border rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">表格只留禁用</button>
                            <button onclick="App.textUtils.base64Encode()" class="p-2 text-sm border rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Base64编码</button>
                            <button onclick="App.textUtils.base64Decode()" class="p-2 text-sm border rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Base64解码</button>
                        </div>
                        <div class="w-full md:w-2/3 space-y-4">
                            <div>
                                <div class="flex justify-end text-xs text-gray-500 mb-1">
                                    <span id="text-stats">输入信息:[0]行,[0]字,已选中[0]字</span>
                                </div>
                                <textarea id="text-input" onkeyup="App.textUtils.saveCache()" onselect="App.textUtils.updateStats()" class="w-full h-48 p-3 border rounded-md dark:bg-gray-700 dark:border-gray-600 focus:ring-1 focus:ring-blue-500" placeholder="在此处输入或粘贴文本..."></textarea>
                            </div>
                            <div>
                                <textarea id="text-output" class="w-full h-48 p-3 border rounded-md dark:bg-gray-700 dark:border-gray-600 focus:ring-1 focus:ring-blue-500" placeholder="处理结果将显示在此处..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 border-t dark:border-gray-700 pt-6">
                        <h3 class="font-semibold mb-2 text-gray-800 dark:text-gray-200">文本工具说明</h3>
                        <div class="text-xs text-gray-600 dark:text-gray-400 leading-relaxed space-y-1">
                            <p>新手提示：文本编辑输入框的内容保存在本地，刷新网页之后，数据不会自动加载。如果数据行数较多，需要点击[加载本地缓存]按钮才能加载本地缓存数据。[替换预定字符]按钮可以批量替换字符，如果想批量删除某些字符，替换数据框留空，点击确认即可批量删除。</p>
                            <p>最近维护：2023年10月26日</p>
                        </div>
                    </div>
                </div>
            `,
            toolComingSoonContent: () => `...` // Content from previous turns
        });

        App.init();
    </script>
</body>
</html>
