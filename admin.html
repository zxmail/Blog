<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的博客 - 管理后台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://gravatar.azure.cc/static/lib/fontawesome5pro/css/all.min.css?v=1.5.8">
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .ql-editor { min-height: 250px; font-size: 16px; line-height: 1.7; }
        .rounded-lg { border-radius: 0.3rem !important; }
        .rounded-md { border-radius: 0.1rem !important; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-200">

    <div id="app"></div>

    <script>
        const App = {
            config: {
                workerUrl: 'https://blog.xy193.workers.dev' // 请替换为您的 Worker URL
            },
            state: {
                posts: [], navItems: [], friendlyLinks: [], recentComments: [], siteStats: null,
                authToken: localStorage.getItem('authToken'), editorInstance: null
            },
            init() {
                this.router();
            },
            router: async () => {
                const appContainer = document.getElementById('app');
                if (!App.state.authToken) {
                    appContainer.innerHTML = App.templates.loginPage();
                    return;
                }
                await Promise.all([ App.fetchDataIfNeeded(), App.fetchNavIfNeeded(), App.fetchFriendlyLinksIfNeeded(), App.fetchRecentCommentsIfNeeded(true), App.fetchSiteStatsIfNeeded(true) ]);
                appContainer.innerHTML = App.templates.adminDashboard();
            },
            fetchDataIfNeeded: async (force = true) => { if (App.state.posts.length === 0 || force) try { const r = await fetch(`${App.config.workerUrl}/api/admin/posts`, { headers: { 'Authorization': `Bearer ${App.state.authToken}` } }); App.state.posts = await r.json(); } catch (e) {} },
            fetchNavIfNeeded: async () => { if (App.state.navItems.length === 0) try { const r = await fetch(`${App.config.workerUrl}/api/nav`); App.state.navItems = await r.json(); } catch (e) {} },
            fetchFriendlyLinksIfNeeded: async () => { if (App.state.friendlyLinks.length === 0) try { const r = await fetch(`${App.config.workerUrl}/api/links`); App.state.friendlyLinks = await r.json(); } catch (e) {} },
            fetchRecentCommentsIfNeeded: async (force = true) => { if (App.state.recentComments.length === 0 || force) try { const r = await fetch(`${App.config.workerUrl}/api/admin/comments`, { headers: { 'Authorization': `Bearer ${App.state.authToken}` } }); App.state.recentComments = await r.json(); } catch (e) {} },
            fetchSiteStatsIfNeeded: async (force = true) => { if (!App.state.siteStats || force) try { const r = await fetch(`${App.config.workerUrl}/api/stats`); App.state.siteStats = await r.json(); } catch (e) {} },
            handleLogin: async (event) => {
                event.preventDefault();
                const { username, password } = event.target;
                try {
                    const res = await fetch(`${App.config.workerUrl}/api/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: username.value, password: password.value }) });
                    const data = await res.json();
                    if (data.success) {
                        localStorage.setItem('authToken', data.token);
                        window.location.reload();
                    } else { alert('登录失败'); }
                } catch (err) { alert('登录出错'); }
            },
            handleLogout: () => {
                localStorage.removeItem('authToken');
                window.location.reload();
            },
            showView: (viewName, param = null) => {
                const el = document.getElementById('admin-content');
                if(!el) return;
                if (viewName === 'posts') el.innerHTML = App.templates.postManager();
                else if (viewName === 'editor') { const post = param ? App.state.posts.find(p => p.slug === param) : {}; el.innerHTML = App.templates.postEditor(post); App.initEditor(post); } 
                else if (viewName === 'nav') el.innerHTML = App.templates.navEditor();
                else if (viewName === 'links') el.innerHTML = App.templates.friendlyLinksEditor();
                else if (viewName === 'settings') el.innerHTML = App.templates.siteSettingsEditor();
                else if (viewName === 'comments') el.innerHTML = App.templates.commentsManager();
            },
            initEditor: (post = {}) => { App.state.editorInstance = new Quill('#editor', { theme: 'snow', modules: { toolbar: [[{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline'], ['link', 'image', 'code-block']] } }); if (post.content) App.state.editorInstance.root.innerHTML = post.content; },
            handlePostFormSubmit: async (e) => { e.preventDefault(); const f=e.target, s=f.dataset.slug, isEdit=!!s, m=isEdit?'PUT':'POST', u=isEdit?`${App.config.workerUrl}/api/admin/posts/${s}`:`${App.config.workerUrl}/api/admin/posts`; const d={title:f.title.value, category:f.category.value, imageUrl:f.imageUrl.value, content:App.state.editorInstance.root.innerHTML, tags:(f.tags.value||'').split(',').map(t=>t.trim()).filter(Boolean), views:f.views.value, isPinned:f.isPinned.checked, date:isEdit?f.dataset.date:null}; try { const r=await fetch(u,{method:m,headers:{'Content-Type':'application/json','Authorization':`Bearer ${App.state.authToken}`},body:JSON.stringify(d)}); if(r.ok) { alert('文章保存成功!'); App.router(); } else { throw new Error('保存失败');} } catch(err) { alert('文章保存失败。');} },
            deletePost: async (slug) => { if (!confirm('确认删除?')) return; try { const r=await fetch(`${App.config.workerUrl}/api/admin/posts/${slug}`,{method:'DELETE',headers:{'Authorization':`Bearer ${App.state.authToken}`}}); if(r.ok) { alert('删除成功'); App.router(); } else throw new Error('删除失败'); } catch(e){alert('删除失败');} },
            addNavItemRow: () => { const c=document.getElementById('nav-item-list'), d=document.createElement('div'); d.className='nav-item-row grid grid-cols-12 gap-2 mb-2'; d.innerHTML=`<input type="text" name="label" placeholder="菜单项名称" class="col-span-5 px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600"><input type="text" name="url" placeholder="URL" class="col-span-4 px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600"><input type="text" name="icon" placeholder="Icon SVG" class="col-span-2 px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600"><button type="button" onclick="App.removeNavItemRow(this)" class="bg-red-500 text-white px-3 py-2 rounded-md col-span-1">-</button>`; c.appendChild(d); },
            removeNavItemRow: (btn) => btn.closest('.nav-item-row').remove(),
            handleNavFormSubmit: async (e) => { e.preventDefault(); const rows=document.querySelectorAll('.nav-item-row'); const parse=()=>{const i=Array.from(rows).map(r=>({label:r.querySelector('[name=label]').value,url:r.querySelector('[name=url]').value,icon:r.querySelector('[name=icon]').value})),s=[{level:-1,children:[]}];for(const t of i){const l=t.label,d=l.match(/^\s*/)[0].length,v=Math.floor(d/2);t.label=l.trim();if(!t.label||!t.url)continue;while(v<=s[s.length-1].level)s.pop();const p=s[s.length-1];if(!p.children)p.children=[];p.children.push(t);s.push({level:v,...t})}return s[0].children}; try {const r=await fetch(`${App.config.workerUrl}/api/admin/nav`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${App.state.authToken}`},body:JSON.stringify(parse())});if(r.ok){alert('导航更新成功'); App.state.navItems=[]; App.router();}else throw new Error('更新失败');}catch(err){alert('更新失败');} },
            addLinkItemRow: () => { const c=document.getElementById('link-item-list'), d=document.createElement('div'); d.className='link-item-row flex items-center gap-2 mb-2'; d.innerHTML=`<input type="text" name="name" placeholder="网站名称" class="flex-1 px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600"><input type="text" name="url" placeholder="URL" class="flex-1 px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600"><button type="button" onclick="App.removeLinkItemRow(this)" class="bg-red-500 text-white px-3 py-2 rounded-md">-</button>`; c.appendChild(d); },
            removeLinkItemRow: (btn) => btn.closest('.link-item-row').remove(),
            handleLinksFormSubmit: async (e) => { e.preventDefault(); const r=document.querySelectorAll('.link-item-row'), l=Array.from(r).map(i=>({name:i.querySelector('[name=name]').value,url:i.querySelector('[name=url]').value})).filter(i=>i.name&&i.url); try {const res=await fetch(`${App.config.workerUrl}/api/admin/links`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${App.state.authToken}`},body:JSON.stringify(l)});if(res.ok){alert('友链更新成功');App.state.friendlyLinks=[];App.router()}else throw new Error('更新失败');}catch(err){alert('更新失败');} },
            deleteComment: async (id) => { if (!confirm('确认删除?')) return; try {const r=await fetch(`${App.config.workerUrl}/api/admin/comments/${id}`,{method:'DELETE',headers:{'Authorization':`Bearer ${App.state.authToken}`}}); if(r.ok){alert('删除成功'); App.state.recentComments=[]; App.router();} else throw new Error('删除失败');}catch(e){alert('删除失败');} },
            handleStatsFormSubmit: async (e) => { e.preventDefault(); const f=e.target,d={posts_total:f.posts_total.value,categories_total:f.categories_total.value,comments_total:f.comments_total.value,contact_email:f.contact_email.value,contact_github:f.contact_github.value}; try { const r=await fetch(`${App.config.workerUrl}/api/admin/stats`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${App.state.authToken}`},body:JSON.stringify(d)}); if(r.ok){alert('统计数据更新成功!'); App.state.siteStats=null; App.router();}else throw new Error('保存失败');}catch(err){alert('统计数据保存失败。');} },
            
            templates: {
                loginPage: () => `<div class="min-h-screen flex items-center justify-center"><div class="max-w-md w-full bg-white dark:bg-gray-800 p-8 rounded-lg shadow-md"><h2 class="text-2xl font-bold text-center mb-6">管理员登录</h2><form onsubmit="App.handleLogin(event)"><div class="mb-4"><label for="username">用户名</label><input type="text" id="username" name="username" required class="mt-1 block w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600"></div><div class="mb-6"><label for="password">密码</label><input type="password" id="password" name="password" required class="mt-1 block w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600"></div><button type="submit" class="w-full py-2 px-4 bg-blue-600 text-white rounded">登录</button></form></div></div>`,
                adminDashboard: () => `<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"><header class="flex justify-between items-center pb-4 border-b border-gray-200 dark:border-gray-700 mb-8"><h1 class="text-2xl font-bold">管理后台</h1><div><a href="index.html" class="text-blue-500 hover:underline mr-4">返回博客</a><button onclick="App.handleLogout()" class="bg-red-500 text-white py-2 px-4 rounded">退出</button></div></header><div class="flex gap-8"><aside class="w-1/5"><ul class="space-y-2"><li><button onclick="App.showView('posts')" class="w-full text-left font-semibold p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">文章管理</button></li><li><button onclick="App.showView('nav')" class="w-full text-left font-semibold p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">导航设置</button></li><li><button onclick="App.showView('links')" class="w-full text-left font-semibold p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">友链管理</button></li><li><button onclick="App.showView('comments')" class="w-full text-left font-semibold p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">评论管理</button></li><li><button onclick="App.showView('settings')" class="w-full text-left font-semibold p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">网站设置</button></li></ul></aside><main id="admin-content" class="w-4/5">${App.templates.postManager()}</main></div></div>`,
                postManager: () => `<div class="w-full"><div class="flex justify-between items-center mb-6"><h2 class="text-xl font-semibold">文章列表</h2><button onclick="App.showView('editor')" class="bg-blue-500 text-white py-2 px-4 rounded-md">撰写新文章</button></div><div class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-x-auto"><table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700"><thead><tr><th class="px-6 py-3 text-left">标题</th><th class="px-6 py-3 text-left">分类</th><th class="px-6 py-3 text-left">日期</th><th class="px-6 py-3 text-right">操作</th></tr></thead><tbody class="divide-y divide-gray-200 dark:divide-gray-700">${App.state.posts.map(p => `<tr><td class="px-6 py-4">${p.title}</td><td class="px-6 py-4">${p.category}</td><td class="px-6 py-4">${new Date(p.date).toLocaleDateString()}</td><td class="px-6 py-4 text-right"><button onclick="App.showView('editor', '${p.slug}')" class="text-indigo-600 dark:text-indigo-400">编辑</button><button onclick="App.deletePost('${p.slug}')" class="text-red-600 dark:text-red-400 ml-2">删除</button></td></tr>`).join('')}</tbody></table></div></div>`,
                postEditor: (post = {}) => `<div class="w-full"><div class="flex justify-between items-center mb-6"><h2 class="text-xl font-semibold">${post.slug ? '编辑文章' : '撰写新文章'}</h2><button onclick="App.showView('posts')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md">返回列表</button></div><form onsubmit="App.handlePostFormSubmit(event)" data-slug="${post.slug || ''}" data-date="${post.date || ''}" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow space-y-6"><div><label for="title">标题</label><input type="text" id="title" name="title" value="${post.title || ''}" required class="mt-1 block w-full border rounded-md"></div><div><label>内容</label><div id="editor"></div></div><button type="submit">保存</button></form></div>`,
                navEditor: () => `<div class="w-full"><h2 class="text-xl font-semibold mb-6">导航菜单设置</h2><form onsubmit="App.handleNavFormSubmit(event)" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow"><div id="nav-item-list"></div><button type="button" onclick="App.addNavItemRow()">+ 添加</button><button type="submit">保存</button></form></div>`,
                friendlyLinksEditor: () => `<div class="w-full"><h2 class="text-xl font-semibold mb-6">友情链接管理</h2><form onsubmit="App.handleLinksFormSubmit(event)" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow"><div id="link-item-list"></div><button type="button" onclick="App.addLinkItemRow()">+ 添加</button><button type="submit">保存</button></form></div>`,
                commentsManager: () => `<div class="w-full"><h2 class="text-xl font-semibold mb-6">评论管理</h2><div class="bg-white dark:bg-gray-800 shadow rounded-lg"><ul class="divide-y dark:divide-gray-700">${(App.state.recentComments || []).map(c => `<li class="p-4"><p>"${c.content}" by ${c.nickname} on ${c.postTitle}</p><button onclick="App.deleteComment('${c.id}')">删除</button></li>`).join('')}</ul></div></div>`,
                siteSettingsEditor: () => `<div class="w-full"><h2 class="text-xl font-semibold mb-6">网站设置</h2><form onsubmit="App.handleStatsFormSubmit(event)" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow space-y-4"><label>文章总数: <input name="posts_total" value="${App.state.siteStats?.posts_total||0}"></label><button type="submit">保存</button></form></div>`,
            }
        };
        App.init();
    </script>
</body>
</html>
