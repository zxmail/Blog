<!DOCTYPE html>
<html lang="zh-CN">
<style>
    /* ... (style section is unchanged) ... */
</style>
<body class="text-gray-800 dark:text-gray-200">

    <div id="app"></div>
    <div id="icon-picker-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" style="display: none;">
        </div>

    <script>
        const App = {
            config: {
                // ...
            },
            state: {
                // ...,
                carouselData: null, // --- 新增 ---
                // ...
            },

            init() {
                // ...
            },
            
            // ... (other functions are unchanged up to showView) ...

            showView: async (viewName, param = null) => {
                const el = document.getElementById('admin-content');
                if (!el) return;
                el.innerHTML = App.templates.loader();

                if (viewName === 'posts') { /* ... */ } 
                else if (viewName === 'editor') { /* ... */ }
                else if (viewName === 'nav') { /* ... */ }
                else if (viewName === 'links') { /* ... */ }
                else if (viewName === 'settings') { /* ... */ }
                else if (viewName === 'comments') { /* ... */ }
                else if (viewName === 'icons') { /* ... */ }
                else if (viewName === 'carousel') { // --- 新增 ---
                    await App.fetchCarouselDataIfNeeded(true);
                    el.innerHTML = App.templates.carouselManager();
                }
            },

            // --- 新增：轮播图管理相关函数 ---
            addCarouselSlideRow: (slide = { imageUrl: '', linkUrl: '' }) => {
                const container = document.getElementById('carousel-slides-list');
                const div = document.createElement('div');
                div.className = 'carousel-slide-row grid grid-cols-12 gap-2 mb-2';
                div.innerHTML = `
                    <input type="url" name="imageUrl" placeholder="图片 URL" class="col-span-6 px-3 py-2 border rounded dark:bg-gray-700 dark:border-gray-600" value="${slide.imageUrl}">
                    <input type="url" name="linkUrl" placeholder="链接 URL" class="col-span-5 px-3 py-2 border rounded dark:bg-gray-700 dark:border-gray-600" value="${slide.linkUrl}">
                    <button type="button" onclick="App.removeCarouselSlideRow(this)" class="bg-red-500 text-white px-3 py-2 rounded col-span-1">-</button>
                `;
                container.appendChild(div);
            },
            removeCarouselSlideRow: (button) => {
                button.closest('.carousel-slide-row').remove();
            },
            handleCarouselFormSubmit: async (event) => {
                event.preventDefault();
                const form = event.target;
                const mode = form.querySelector('input[name="mode"]:checked').value;
                const rows = form.querySelectorAll('.carousel-slide-row');
                const slides = Array.from(rows).map(row => ({
                    imageUrl: row.querySelector('[name=imageUrl]').value,
                    linkUrl: row.querySelector('[name=linkUrl]').value,
                })).filter(s => s.imageUrl);

                const data = { mode, slides };

                try {
                    const res = await fetch(`${App.config.workerUrl}/api/admin/carousel`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${App.state.authToken}` },
                        body: JSON.stringify(data)
                    });
                    if (res.ok) {
                        alert('轮播图设置保存成功！');
                        App.state.carouselData = data;
                    } else { throw new Error('保存失败'); }
                } catch (e) {
                    alert('保存失败，请检查网络或联系管理员。');
                }
            },

            // ... (other admin actions) ...
            
            // --- Data Fetching ---
            fetchCarouselDataIfNeeded: async (force = false) => {
                if (!App.state.carouselData || force) {
                    try {
                        const res = await fetch(`${App.config.workerUrl}/api/carousel`);
                        App.state.carouselData = await res.json();
                    } catch (e) { console.error('Failed to fetch carousel data', e); }
                }
            },
            // ... (other fetch functions) ...

            // --- Templates ---
            templates: {
                // ...
                adminDashboard: () => `<div class="bg-white dark:bg-gray-900"><div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"><header class="flex justify-between items-center pb-4 border-b border-gray-200 dark:border-gray-700 mb-8"><h1 class="text-2xl font-bold">管理后台</h1><div><a href="index.html" class="text-blue-500 hover:underline mr-4">返回博客</a><button onclick="App.handleLogout()" class="bg-red-500 text-white py-2 px-4 rounded">退出</button></div></header><div class="flex gap-8"><aside class="w-1/5"><ul class="space-y-2">
                    <li><button onclick="App.showView('posts')" class="w-full text-left font-semibold p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">文章管理</button></li>
                    <li><button onclick="App.showView('nav')" class="w-full text-left font-semibold p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">导航设置</button></li>
                    <li><button onclick="App.showView('links')" class="w-full text-left font-semibold p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">友链管理</button></li>
                    <li><button onclick="App.showView('carousel')" class="w-full text-left font-semibold p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">轮播图管理</button></li>
                    <li><button onclick="App.showView('comments')" class="w-full text-left font-semibold p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">评论管理</button></li>
                    <li><button onclick="App.showView('settings')" class="w-full text-left font-semibold p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">网站设置</button></li>
                    <li><button onclick="App.showView('icons')" class="w-full text-left font-semibold p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">图标展示</button></li>
                    </ul></aside><main id="admin-content" class="w-4/5">${App.templates.postManager()}</main></div></div></div>`,
                
                // --- 新增：轮播图管理模板 ---
                carouselManager: () => {
                    const data = App.state.carouselData || { mode: 'fade', slides: [] };
                    setTimeout(() => {
                        data.slides.forEach(slide => App.addCarouselSlideRow(slide));
                    }, 0);
                    return `
                    <div class="w-full">
                        <h2 class="text-xl font-semibold mb-6">轮播图管理</h2>
                        <form onsubmit="App.handleCarouselFormSubmit(event)" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                            <div class="mb-6">
                                <h3 class="text-lg font-medium mb-2">轮播模式</h3>
                                <div class="flex items-center gap-6">
                                    <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="mode" value="fade" class="form-radio" ${data.mode === 'fade' ? 'checked' : ''}><span>渐变 (Fade)</span></label>
                                    <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="mode" value="slide" class="form-radio" ${data.mode === 'slide' ? 'checked' : ''}><span>旋转木马 (Slide)</span></label>
                                </div>
                            </div>

                            <div class="mb-4">
                                <h3 class="text-lg font-medium mb-2">海报列表</h3>
                                <div class="grid grid-cols-12 gap-2 mb-2 text-sm font-semibold">
                                    <div class="col-span-6">图片 URL</div>
                                    <div class="col-span-5">链接 URL</div>
                                </div>
                                <div id="carousel-slides-list" class="space-y-2">
                                    </div>
                            </div>
                            
                            <button type="button" onclick="App.addCarouselSlideRow()" class="text-sm bg-gray-200 dark:bg-gray-700 py-2 px-4 rounded-md mb-4">+ 添加海报</button>
                            
                            <div class="text-right border-t dark:border-gray-700 pt-4">
                                <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md">保存设置</button>
                            </div>
                        </form>
                    </div>`;
                },
                // ... (rest of the templates are unchanged)
            }
        };
        App.init();
    </script>
</body>
</html>
