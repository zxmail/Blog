<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>在线工具 - 我的博客</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://gravatar.azure.cc/static/lib/fontawesome5pro/css/all.min.css?v=1.5.8">
    <script src="https://cdn.jsdelivr.net/npm/otpauth@9.2.2/dist/otpauth.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'accent': '#4ade80', // Green accent color
                    },
                },
            },
        };
    </script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            background-color: #f7fafc;
        }
        .dark body {
            background-color: #1a202c;
        }
        .tool-sidebar a.active {
            background-color: #4ade80; /* Green accent */
            color: white;
        }
        .tool-sidebar a.active i, .tool-sidebar a.active span {
            color: white !important;
        }
    </style>
</head>
<body class="text-gray-800 dark:text-gray-200">

    <div id="app" class="flex h-screen">
        </div>

    <script>
        const App = {
            state: {
                // '2fa' or 'qrcode'
                activeTool: '2fa', 
                // For 2FA tool
                totp: null,
                totpInterval: null,
            },
            
            init() {
                this.renderPage();
                this.update2FACode(); // Initial call
            },
            
            // --- Page Rendering ---
            renderPage() {
                const appContainer = document.getElementById('app');
                appContainer.innerHTML = this.templates.mainLayout();
                this.renderToolContent();
            },
            
            renderToolContent() {
                const contentContainer = document.getElementById('tool-content');
                if (contentContainer) {
                    if (this.state.activeTool === '2fa') {
                        contentContainer.innerHTML = this.templates.tool2FA();
                        this.update2FACode();
                    } else if (this.state.activeTool === 'qrcode') {
                        contentContainer.innerHTML = this.templates.toolQRCode();
                    }
                }
            },
            
            // --- Tool Switching ---
            setActiveTool(toolName) {
                this.state.activeTool = toolName;
                this.renderPage();
            },

            // --- 2FA Tool Logic ---
            update2FACode() {
                const keyInput = document.getElementById('2fa-key-input');
                const secretKey = keyInput?.value.trim().replace(/\s/g, '');

                const codeDisplay = document.getElementById('2fa-code');
                const timeDisplay = document.getElementById('2fa-time');
                const progressDisplay = document.getElementById('2fa-progress');

                if (!secretKey || !codeDisplay || !timeDisplay || !progressDisplay) {
                    return;
                }

                // Clear previous interval
                if (this.state.totpInterval) {
                    clearInterval(this.state.totpInterval);
                }

                try {
                    this.state.totp = new otpauth.TOTP({
                        issuer: "ACME",
                        label: "AzureDiamond",
                        algorithm: "SHA1",
                        digits: 6,
                        period: 30,
                        secret: secretKey,
                    });

                    const update = () => {
                        const token = this.state.totp.generate();
                        const remainingTime = 30 - (Math.floor(Date.now() / 1000) % 30);
                        const progress = (remainingTime / 30) * 100;
                        
                        codeDisplay.textContent = token;
                        timeDisplay.textContent = `剩余时间: ${remainingTime} 秒`;
                        progressDisplay.style.width = `${progress}%`;
                        
                        if(remainingTime < 5) {
                            codeDisplay.classList.add('text-red-500');
                        } else {
                            codeDisplay.classList.remove('text-red-500');
                        }
                    };
                    
                    update(); // Initial call
                    this.state.totpInterval = setInterval(update, 1000);

                } catch (error) {
                    codeDisplay.textContent = '密钥无效';
                    timeDisplay.textContent = '请输入有效的Base32密钥';
                    progressDisplay.style.width = '0%';
                }
            },

            // --- QR Code Tool Logic ---
            generateQRCode() {
                const textInput = document.getElementById('qr-text-input');
                const canvas = document.getElementById('qr-canvas');
                
                if (!textInput || !canvas) return;

                const text = textInput.value.trim();
                if (text === '') {
                    canvas.innerHTML = '<p class="text-gray-400">请输入内容以生成二维码</p>';
                    return;
                }
                
                canvas.innerHTML = ''; // Clear previous QR Code
                QRCode.toCanvas(canvas, text, { width: 256 }, function (error) {
                    if (error) {
                        canvas.innerHTML = '<p class="text-red-500">二维码生成失败，请重试。</p>';
                        console.error(error);
                    }
                });
            },
            
            templates: {
                mainLayout: () => `
                    ${App.templates.toolSidebar()}
                    <main class="flex-1 bg-white dark:bg-gray-800 p-6 sm:p-8 overflow-y-auto">
                        <div id="tool-content">
                            </div>
                    </main>
                `,
                toolSidebar: () => `
                    <aside class="w-24 bg-gray-50 dark:bg-gray-900 p-4 flex flex-col items-center space-y-6">
                        <div class="text-center">
                             <div class="w-12 h-12 rounded-full bg-accent flex items-center justify-center mb-2">
                                <i class="fas fa-shield-check text-2xl text-white"></i>
                            </div>
                            <span class="font-bold text-sm">2FA工具</span>
                        </div>
                        <nav class="tool-sidebar flex flex-col items-center space-y-4">
                            <a href="#" onclick="App.setActiveTool('2fa')" class="flex flex-col items-center p-3 rounded-lg ${App.state.activeTool === '2fa' ? 'active' : ''}">
                                <i class="fas fa-user-shield text-2xl text-gray-500"></i>
                                <span class="text-xs mt-1 text-gray-600 dark:text-gray-400">2FA验证</span>
                            </a>
                            <a href="#" onclick="App.setActiveTool('qrcode')" class="flex flex-col items-center p-3 rounded-lg ${App.state.activeTool === 'qrcode' ? 'active' : ''}">
                                <i class="fas fa-qrcode text-2xl text-gray-500"></i>
                                <span class="text-xs mt-1 text-gray-600 dark:text-gray-400">在线生成QR码</span>
                            </a>
                        </nav>
                    </aside>
                `,
                tool2FA: () => `
                    <div>
                        <h1 class="text-2xl font-bold mb-2">2FA验证</h1>
                        <p class="text-gray-500 dark:text-gray-400 mb-6">双因素验证(2FA)在线工具（相当于谷歌身份验证器），使用前请将密钥信息复制在下方即可。</p>

                        <div class="mb-4">
                            <input id="2fa-key-input" type="text" placeholder="请在此处输入2FA密钥 (Secret Key)" class="w-full px-4 py-3 border-2 rounded-md dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:border-accent">
                        </div>
                        <button onclick="App.update2FACode()" class="bg-accent text-white font-bold px-6 py-3 rounded-md hover:opacity-90">点击获取验证码</button>
                        
                        <div class="mt-6 p-4 border dark:border-gray-700 rounded-md">
                            <p class="text-sm text-gray-500">当前验证码 (已实时刷新):</p>
                            <p id="2fa-code" class="text-4xl font-mono font-bold my-2 tracking-widest">------</p>
                            <p id="2fa-time" class="text-sm text-gray-500 mb-2">等待输入密钥...</p>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
                                <div id="2fa-progress" class="bg-accent h-1.5 rounded-full" style="width: 100%; transition: width 1s linear;"></div>
                            </div>
                        </div>

                        <hr class="my-8 dark:border-gray-700">

                        <div>
                            <h2 class="text-xl font-bold mb-2">2FA工具说明</h2>
                            <div class="text-sm text-gray-600 dark:text-gray-400 space-y-2">
                                <p><strong>提示帮助：</strong> 欢迎使用在线两步验证码生成工具，粘贴或输入您的密钥即可验证。否则默认输入框的密钥，是本站提供的虚拟测试密钥，生存期为永久。</p>
                                <p><strong>数据说明：</strong> 所有验证过程均在您的浏览器本地完成，密钥信息不会上传至网络服务器，保障您的数据安全。刷新页面或关闭浏览器，密钥将会自动清空。</p>
                            </div>
                        </div>
                    </div>
                `,
                toolQRCode: () => `
                    <div>
                        <h1 class="text-2xl font-bold mb-2">在线生成二维码(QR码)</h1>
                        <p class="text-gray-500 dark:text-gray-400 mb-6">在下方的文本框中输入您想要生成二维码的内容，可以是网址、文字、联系方式等。</p>

                        <div class="mb-4">
                            <textarea id="qr-text-input" rows="4" placeholder="请输入内容..." class="w-full px-4 py-3 border-2 rounded-md dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:border-accent" onkeyup="App.generateQRCode()"></textarea>
                        </div>
                        
                        <div class="mt-6 p-4 border dark:border-gray-700 rounded-md flex items-center justify-center" style="min-height: 288px;">
                            <canvas id="qr-canvas"><p class="text-gray-400">请输入内容以生成二维码</p></canvas>
                        </div>

                         <hr class="my-8 dark:border-gray-700">

                        <div>
                            <h2 class="text-xl font-bold mb-2">QR码工具说明</h2>
                            <div class="text-sm text-gray-600 dark:text-gray-400 space-y-2">
                                <p><strong>提示帮助：</strong> QR码（快速响应矩阵码）是一种二维条码，可以被智能手机摄像头快速读取。它常用于存储网址、联系信息、Wi-Fi密码等。</p>
                                <p><strong>数据说明：</strong> 所有二维码均在您的浏览器本地实时生成，输入的内容不会被发送到任何服务器。您可以右键点击生成的二维码图片进行保存。</p>
                            </div>
                        </div>
                    </div>
                `,
            }
        };
        
        App.init();
    </script>
</body>
</html>
